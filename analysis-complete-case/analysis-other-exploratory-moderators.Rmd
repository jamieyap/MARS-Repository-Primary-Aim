---
title: "MARS MRT: Additional analyses"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document:
    toc: TRUE
    toc_depth: 4
    number_sections: TRUE
---

```{=html}
<style type="text/css">
.main-container {
  max-width: 1800px !important;
  margin-left: auto;
  margin-right: auto;
}
</style>
```
```{r global_options, include=FALSE}
knitr::opts_chunk$set(tidy = TRUE)
knitr::opts_chunk$set(fig.pos = 'H')
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)
options(width = 7000)
```

```{r}
source("paths.R")
library(knitr)
library(tidyverse)
library(MRTAnalysis)
```

```{r}
is_dir_exist <- file.exists(file.path("analysis-complete-case", "formatted-output"))

if(isFALSE(is_dir_exist)){
  dir.create(file.path("analysis-complete-case", "formatted-output"))
}

is_dir_exist <- file.exists(file.path("analysis-complete-case", "formatted-output", "other-exploratory-moderators"))

if(isFALSE(is_dir_exist)){
  dir.create(file.path("analysis-complete-case", "formatted-output", "other-exploratory-moderators"))
}
```

The analyses in this document investigate whether there might be other moderators of the effect of prompt versus no prompt (aside from the ones investigated for Hypothesis 3a and 3b).

```{r}
# This is the data frame that is the output of the very last step of our data pipeline
dat_primary_aim <- readRDS(file = file.path(path_manipulated_data, "dat_primary_aim.rds")) 
dat_primary_aim <- dat_primary_aim %>%
  # Note that in contrast to H1, in H3 there is no sensitivity analysis where we re-do the analyses using all 10 days of the MRT
  mutate(is_include_main = if_else((decision_point >= 7) & (decision_point <= 54), 1, 0))                                                    
```

```{r}
dat_primary_aim <- dat_primary_aim %>% 
  mutate(eligibility_lag1 = lag(eligibility))
```

```{r}
dat_primary_aim <- dat_primary_aim %>% filter(is_include_main == 1)
```

```{r}
dat_primary_aim <- dat_primary_aim %>%
  select(participant_id, decision_point, eligibility, 
         coinflip, Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val,
         eligibility_lag1, coinflip_most_recent_eligible, hours_elapsed_since_most_recent_eligible,
         cig_available, negative_affect, dichotomized_2qs_response) 
```

```{r}
dat_primary_aim %>% filter(eligibility == 1) %>% group_by(cig_available, negative_affect) %>% summarise(n())
```

```{r}
my_list <- list(Y = -1,
                coinflip = -1,
                hour_coinflip_local = -1, 
                days_between_v1_and_coinflip_local = -1,
                any_response_2qs = -1, 
                any_recent_eligible_dp = -1, 
                engagement_most_recent_eligible = -1,
                age = -1, 
                is_male = -1, 
                is_latino = -1, 
                is_not_latino_and_black = -1, 
                is_not_latino_and_other = -1, 
                baseline_tobacco_history = -1, 
                has_partner = -1, 
                income_val = -1,
                cig_available = -1,
                negative_affect = -1,
                dichotomized_2qs_response = -1)
```

# Age

```{r}
use_these_moderators <- c("age")
```

```{r}
dat_for_analysis <- dat_primary_aim
```

```{r}
logical_vec_cc <- dat_for_analysis %>% 
  select(Y, eligibility,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)

dat_summary_observed <- dat_for_analysis %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1) %>%
  group_by(is_complete) %>%
  summarise(total = n())

n_participants_included_among_elig <- dat_for_analysis %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1 & is_complete == 1) %>% 
  summarise(total = length(unique(participant_id))) %>%
  .[["total"]]

n_participants_elig <- dat_for_analysis %>%
  filter(eligibility == 1) %>%
  .[["participant_id"]] %>%
  unique(.) %>%
  length(.)

n_participants_excluded_among_elig <- n_participants_elig - n_participants_included_among_elig

dat_summary <- data.frame(n_participants_elig = n_participants_elig,
                          n_participants_included_among_elig = n_participants_included_among_elig,
                          n_participants_excluded_among_elig = n_participants_excluded_among_elig,
                          n_elig = sum(dat_summary_observed[["total"]]),
                          n_included_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == TRUE, ][["total"]],
                          n_excluded_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == FALSE, ][["total"]])

dat_summary
```

```{r}
dat_for_analysis_elig <- dat_for_analysis %>% filter(eligibility == 1)
dat_for_analysis_not_elig <- dat_for_analysis %>% filter(eligibility == 0)
```

```{r}
logical_vec_cc <- dat_for_analysis_elig %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val,
         all_of(use_these_moderators)) %>%
  complete.cases(.)
```

```{r}
# Note that this line is needed because we are doing a complete case analysis
# We would not need this line if we were doing a multiply imputed analysis
dat_for_analysis_elig <- dat_for_analysis_elig %>% mutate(eligibility = if_else(logical_vec_cc, eligibility, 0))
```

```{r}
dat_for_analysis <- rbind(dat_for_analysis_elig, dat_for_analysis_not_elig)
dat_for_analysis <- dat_for_analysis %>% arrange(participant_id, decision_point)
dat_for_analysis <- dat_for_analysis %>% replace_na(my_list)
```

```{r}
participants_fully_dropped <- dat_for_analysis %>% 
  group_by(participant_id) %>% 
  summarise(count_elig = sum(eligibility)) %>%
  arrange(count_elig) %>%
  filter(count_elig == 0) %>%
  .[["participant_id"]]

if(length(participants_fully_dropped) > 0){
  dat_for_analysis <- dat_for_analysis %>% filter(!(participant_id %in% participants_fully_dropped))
}
```

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ age,  
  control_formula = ~ age + is_male + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_response_2qs + any_recent_eligible_dp + engagement_most_recent_eligible, 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)
```

```{r}
fit <- fit1

dat_result_causal <- summary(fit, show_control_fit = TRUE)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE)[["control_variables"]]

dat_result <- rbind(dat_result_causal, dat_result_control)

dat_result_causal <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["control_variables"]]
dat_result2 <- rbind(dat_result_causal, dat_result_control)
dat_result2 <- dat_result2[, c("90% LCL", "90% UCL")]
dat_result <- cbind(dat_result, dat_result2)

these_row_names <- rownames(dat_result)
dat_result <- as.data.frame(dat_result)
dat_result <- dat_result %>% select(Estimate, StdErr, `95% LCL`, `95% UCL`, `90% LCL`, `90% UCL`, everything()) 
dat_result <- as.matrix(dat_result)
row.names(dat_result) <- these_row_names

# Format output to 3 decimal places
dat_result %>% round(., 3) %>% format(., nsmall = 3) %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "other-exploratory-moderators", "log_risk_ratio_scale_age.csv"), row.names = TRUE)
```

# Gender

```{r}
use_these_moderators <- c("is_male")
```

```{r}
dat_for_analysis <- dat_primary_aim
```

```{r}
logical_vec_cc <- dat_for_analysis %>% 
  select(Y, eligibility,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)

dat_summary_observed <- dat_for_analysis %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1) %>%
  group_by(is_complete) %>%
  summarise(total = n())

n_participants_included_among_elig <- dat_for_analysis %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1 & is_complete == 1) %>% 
  summarise(total = length(unique(participant_id))) %>%
  .[["total"]]

n_participants_elig <- dat_for_analysis %>%
  filter(eligibility == 1) %>%
  .[["participant_id"]] %>%
  unique(.) %>%
  length(.)

n_participants_excluded_among_elig <- n_participants_elig - n_participants_included_among_elig

dat_summary <- data.frame(n_participants_elig = n_participants_elig,
                          n_participants_included_among_elig = n_participants_included_among_elig,
                          n_participants_excluded_among_elig = n_participants_excluded_among_elig,
                          n_elig = sum(dat_summary_observed[["total"]]),
                          n_included_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == TRUE, ][["total"]],
                          n_excluded_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == FALSE, ][["total"]])

dat_summary
```

```{r}
dat_for_analysis_elig <- dat_for_analysis %>% filter(eligibility == 1)
dat_for_analysis_not_elig <- dat_for_analysis %>% filter(eligibility == 0)
```

```{r}
logical_vec_cc <- dat_for_analysis_elig %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val,
         all_of(use_these_moderators)) %>%
  complete.cases(.)
```

```{r}
# Note that this line is needed because we are doing a complete case analysis
# We would not need this line if we were doing a multiply imputed analysis
dat_for_analysis_elig <- dat_for_analysis_elig %>% mutate(eligibility = if_else(logical_vec_cc, eligibility, 0))
```

```{r}
dat_for_analysis <- rbind(dat_for_analysis_elig, dat_for_analysis_not_elig)
dat_for_analysis <- dat_for_analysis %>% arrange(participant_id, decision_point)
dat_for_analysis <- dat_for_analysis %>% replace_na(my_list)
```

```{r}
participants_fully_dropped <- dat_for_analysis %>% 
  group_by(participant_id) %>% 
  summarise(count_elig = sum(eligibility)) %>%
  arrange(count_elig) %>%
  filter(count_elig == 0) %>%
  .[["participant_id"]]

if(length(participants_fully_dropped) > 0){
  dat_for_analysis <- dat_for_analysis %>% filter(!(participant_id %in% participants_fully_dropped))
}
```

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ is_male,  
  control_formula = ~ age + is_male + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_response_2qs + any_recent_eligible_dp + engagement_most_recent_eligible, 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)
```

```{r}
fit <- fit1

dat_result_causal <- summary(fit, show_control_fit = TRUE)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE)[["control_variables"]]

dat_result <- rbind(dat_result_causal, dat_result_control)

dat_result_causal <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["control_variables"]]
dat_result2 <- rbind(dat_result_causal, dat_result_control)
dat_result2 <- dat_result2[, c("90% LCL", "90% UCL")]
dat_result <- cbind(dat_result, dat_result2)

these_row_names <- rownames(dat_result)
dat_result <- as.data.frame(dat_result)
dat_result <- dat_result %>% select(Estimate, StdErr, `95% LCL`, `95% UCL`, `90% LCL`, `90% UCL`, everything()) 
dat_result <- as.matrix(dat_result)
row.names(dat_result) <- these_row_names

# Format output to 3 decimal places
dat_result %>% round(., 3) %>% format(., nsmall = 3) %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "other-exploratory-moderators", "log_risk_ratio_scale_gender.csv"), row.names = TRUE)
```

# Race/ethnicity

```{r}
use_these_moderators <- c("is_latino", "is_not_latino_and_black", "is_not_latino_and_other")
```

```{r}
dat_for_analysis <- dat_primary_aim
```

```{r}
logical_vec_cc <- dat_for_analysis %>% 
  select(Y, eligibility,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)

dat_summary_observed <- dat_for_analysis %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1) %>%
  group_by(is_complete) %>%
  summarise(total = n())

n_participants_included_among_elig <- dat_for_analysis %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1 & is_complete == 1) %>% 
  summarise(total = length(unique(participant_id))) %>%
  .[["total"]]

n_participants_elig <- dat_for_analysis %>%
  filter(eligibility == 1) %>%
  .[["participant_id"]] %>%
  unique(.) %>%
  length(.)

n_participants_excluded_among_elig <- n_participants_elig - n_participants_included_among_elig

dat_summary <- data.frame(n_participants_elig = n_participants_elig,
                          n_participants_included_among_elig = n_participants_included_among_elig,
                          n_participants_excluded_among_elig = n_participants_excluded_among_elig,
                          n_elig = sum(dat_summary_observed[["total"]]),
                          n_included_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == TRUE, ][["total"]],
                          n_excluded_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == FALSE, ][["total"]])

dat_summary
```

```{r}
dat_for_analysis_elig <- dat_for_analysis %>% filter(eligibility == 1)
dat_for_analysis_not_elig <- dat_for_analysis %>% filter(eligibility == 0)
```

```{r}
logical_vec_cc <- dat_for_analysis_elig %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val,
         all_of(use_these_moderators)) %>%
  complete.cases(.)
```

```{r}
# Note that this line is needed because we are doing a complete case analysis
# We would not need this line if we were doing a multiply imputed analysis
dat_for_analysis_elig <- dat_for_analysis_elig %>% mutate(eligibility = if_else(logical_vec_cc, eligibility, 0))
```

```{r}
dat_for_analysis <- rbind(dat_for_analysis_elig, dat_for_analysis_not_elig)
dat_for_analysis <- dat_for_analysis %>% arrange(participant_id, decision_point)
dat_for_analysis <- dat_for_analysis %>% replace_na(my_list)
```

```{r}
participants_fully_dropped <- dat_for_analysis %>% 
  group_by(participant_id) %>% 
  summarise(count_elig = sum(eligibility)) %>%
  arrange(count_elig) %>%
  filter(count_elig == 0) %>%
  .[["participant_id"]]

if(length(participants_fully_dropped) > 0){
  dat_for_analysis <- dat_for_analysis %>% filter(!(participant_id %in% participants_fully_dropped))
}
```

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ is_latino + is_not_latino_and_black + is_not_latino_and_other,  
  control_formula = ~ age + is_male + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_response_2qs + any_recent_eligible_dp + engagement_most_recent_eligible, 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)
```

```{r}
fit <- fit1

dat_result_causal <- summary(fit, show_control_fit = TRUE)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE)[["control_variables"]]

dat_result <- rbind(dat_result_causal, dat_result_control)

dat_result_causal <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["control_variables"]]
dat_result2 <- rbind(dat_result_causal, dat_result_control)
dat_result2 <- dat_result2[, c("90% LCL", "90% UCL")]
dat_result <- cbind(dat_result, dat_result2)

these_row_names <- rownames(dat_result)
dat_result <- as.data.frame(dat_result)
dat_result <- dat_result %>% select(Estimate, StdErr, `95% LCL`, `95% UCL`, `90% LCL`, `90% UCL`, everything()) 
dat_result <- as.matrix(dat_result)
row.names(dat_result) <- these_row_names

# Format output to 3 decimal places
dat_result %>% round(., 3) %>% format(., nsmall = 3) %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "other-exploratory-moderators", "log_risk_ratio_scale_ethnicity.csv"), row.names = TRUE)
```

# Baseline tobacco history

```{r}
use_these_moderators <- c("baseline_tobacco_history")
```

```{r}
dat_for_analysis <- dat_primary_aim
```

```{r}
logical_vec_cc <- dat_for_analysis %>% 
  select(Y, eligibility,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)

dat_summary_observed <- dat_for_analysis %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1) %>%
  group_by(is_complete) %>%
  summarise(total = n())

n_participants_included_among_elig <- dat_for_analysis %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1 & is_complete == 1) %>% 
  summarise(total = length(unique(participant_id))) %>%
  .[["total"]]

n_participants_elig <- dat_for_analysis %>%
  filter(eligibility == 1) %>%
  .[["participant_id"]] %>%
  unique(.) %>%
  length(.)

n_participants_excluded_among_elig <- n_participants_elig - n_participants_included_among_elig

dat_summary <- data.frame(n_participants_elig = n_participants_elig,
                          n_participants_included_among_elig = n_participants_included_among_elig,
                          n_participants_excluded_among_elig = n_participants_excluded_among_elig,
                          n_elig = sum(dat_summary_observed[["total"]]),
                          n_included_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == TRUE, ][["total"]],
                          n_excluded_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == FALSE, ][["total"]])

dat_summary
```

```{r}
dat_for_analysis_elig <- dat_for_analysis %>% filter(eligibility == 1)
dat_for_analysis_not_elig <- dat_for_analysis %>% filter(eligibility == 0)
```

```{r}
logical_vec_cc <- dat_for_analysis_elig %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val,
         all_of(use_these_moderators)) %>%
  complete.cases(.)
```

```{r}
# Note that this line is needed because we are doing a complete case analysis
# We would not need this line if we were doing a multiply imputed analysis
dat_for_analysis_elig <- dat_for_analysis_elig %>% mutate(eligibility = if_else(logical_vec_cc, eligibility, 0))
```

```{r}
dat_for_analysis <- rbind(dat_for_analysis_elig, dat_for_analysis_not_elig)
dat_for_analysis <- dat_for_analysis %>% arrange(participant_id, decision_point)
dat_for_analysis <- dat_for_analysis %>% replace_na(my_list)
```

```{r}
participants_fully_dropped <- dat_for_analysis %>% 
  group_by(participant_id) %>% 
  summarise(count_elig = sum(eligibility)) %>%
  arrange(count_elig) %>%
  filter(count_elig == 0) %>%
  .[["participant_id"]]

if(length(participants_fully_dropped) > 0){
  dat_for_analysis <- dat_for_analysis %>% filter(!(participant_id %in% participants_fully_dropped))
}
```

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ baseline_tobacco_history,  
  control_formula = ~ age + is_male + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_response_2qs + any_recent_eligible_dp + engagement_most_recent_eligible, 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)
```

```{r}
fit <- fit1

dat_result_causal <- summary(fit, show_control_fit = TRUE)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE)[["control_variables"]]

dat_result <- rbind(dat_result_causal, dat_result_control)

dat_result_causal <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["control_variables"]]
dat_result2 <- rbind(dat_result_causal, dat_result_control)
dat_result2 <- dat_result2[, c("90% LCL", "90% UCL")]
dat_result <- cbind(dat_result, dat_result2)

these_row_names <- rownames(dat_result)
dat_result <- as.data.frame(dat_result)
dat_result <- dat_result %>% select(Estimate, StdErr, `95% LCL`, `95% UCL`, `90% LCL`, `90% UCL`, everything()) 
dat_result <- as.matrix(dat_result)
row.names(dat_result) <- these_row_names

# Format output to 3 decimal places
dat_result %>% round(., 3) %>% format(., nsmall = 3) %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "other-exploratory-moderators", "log_risk_ratio_scale_baseline_tobacco_history.csv"), row.names = TRUE)
```

# Partner Status

```{r}
use_these_moderators <- c("has_partner")
```

```{r}
dat_for_analysis <- dat_primary_aim
```

```{r}
logical_vec_cc <- dat_for_analysis %>% 
  select(Y, eligibility,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)

dat_summary_observed <- dat_for_analysis %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1) %>%
  group_by(is_complete) %>%
  summarise(total = n())

n_participants_included_among_elig <- dat_for_analysis %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1 & is_complete == 1) %>% 
  summarise(total = length(unique(participant_id))) %>%
  .[["total"]]

n_participants_elig <- dat_for_analysis %>%
  filter(eligibility == 1) %>%
  .[["participant_id"]] %>%
  unique(.) %>%
  length(.)

n_participants_excluded_among_elig <- n_participants_elig - n_participants_included_among_elig

dat_summary <- data.frame(n_participants_elig = n_participants_elig,
                          n_participants_included_among_elig = n_participants_included_among_elig,
                          n_participants_excluded_among_elig = n_participants_excluded_among_elig,
                          n_elig = sum(dat_summary_observed[["total"]]),
                          n_included_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == TRUE, ][["total"]],
                          n_excluded_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == FALSE, ][["total"]])

dat_summary
```

```{r}
dat_for_analysis_elig <- dat_for_analysis %>% filter(eligibility == 1)
dat_for_analysis_not_elig <- dat_for_analysis %>% filter(eligibility == 0)
```

```{r}
logical_vec_cc <- dat_for_analysis_elig %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val,
         all_of(use_these_moderators)) %>%
  complete.cases(.)
```

```{r}
# Note that this line is needed because we are doing a complete case analysis
# We would not need this line if we were doing a multiply imputed analysis
dat_for_analysis_elig <- dat_for_analysis_elig %>% mutate(eligibility = if_else(logical_vec_cc, eligibility, 0))
```

```{r}
dat_for_analysis <- rbind(dat_for_analysis_elig, dat_for_analysis_not_elig)
dat_for_analysis <- dat_for_analysis %>% arrange(participant_id, decision_point)
dat_for_analysis <- dat_for_analysis %>% replace_na(my_list)
```

```{r}
participants_fully_dropped <- dat_for_analysis %>% 
  group_by(participant_id) %>% 
  summarise(count_elig = sum(eligibility)) %>%
  arrange(count_elig) %>%
  filter(count_elig == 0) %>%
  .[["participant_id"]]

if(length(participants_fully_dropped) > 0){
  dat_for_analysis <- dat_for_analysis %>% filter(!(participant_id %in% participants_fully_dropped))
}
```

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ has_partner,  
  control_formula = ~ age + is_male + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_response_2qs + any_recent_eligible_dp + engagement_most_recent_eligible, 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)
```

```{r}
fit <- fit1

dat_result_causal <- summary(fit, show_control_fit = TRUE)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE)[["control_variables"]]

dat_result <- rbind(dat_result_causal, dat_result_control)

dat_result_causal <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["control_variables"]]
dat_result2 <- rbind(dat_result_causal, dat_result_control)
dat_result2 <- dat_result2[, c("90% LCL", "90% UCL")]
dat_result <- cbind(dat_result, dat_result2)

these_row_names <- rownames(dat_result)
dat_result <- as.data.frame(dat_result)
dat_result <- dat_result %>% select(Estimate, StdErr, `95% LCL`, `95% UCL`, `90% LCL`, `90% UCL`, everything()) 
dat_result <- as.matrix(dat_result)
row.names(dat_result) <- these_row_names

# Format output to 3 decimal places
dat_result %>% round(., 3) %>% format(., nsmall = 3) %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "other-exploratory-moderators", "log_risk_ratio_scale_has_partner.csv"), row.names = TRUE)
```

# Socio-economic status

```{r}
use_these_moderators <- c("income_val")
```

```{r}
dat_for_analysis <- dat_primary_aim
```

```{r}
logical_vec_cc <- dat_for_analysis %>% 
  select(Y, eligibility,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)

dat_summary_observed <- dat_for_analysis %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1) %>%
  group_by(is_complete) %>%
  summarise(total = n())

n_participants_included_among_elig <- dat_for_analysis %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1 & is_complete == 1) %>% 
  summarise(total = length(unique(participant_id))) %>%
  .[["total"]]

n_participants_elig <- dat_for_analysis %>%
  filter(eligibility == 1) %>%
  .[["participant_id"]] %>%
  unique(.) %>%
  length(.)

n_participants_excluded_among_elig <- n_participants_elig - n_participants_included_among_elig

dat_summary <- data.frame(n_participants_elig = n_participants_elig,
                          n_participants_included_among_elig = n_participants_included_among_elig,
                          n_participants_excluded_among_elig = n_participants_excluded_among_elig,
                          n_elig = sum(dat_summary_observed[["total"]]),
                          n_included_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == TRUE, ][["total"]],
                          n_excluded_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == FALSE, ][["total"]])

dat_summary
```

```{r}
dat_for_analysis_elig <- dat_for_analysis %>% filter(eligibility == 1)
dat_for_analysis_not_elig <- dat_for_analysis %>% filter(eligibility == 0)
```

```{r}
logical_vec_cc <- dat_for_analysis_elig %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val,
         all_of(use_these_moderators)) %>%
  complete.cases(.)
```

```{r}
# Note that this line is needed because we are doing a complete case analysis
# We would not need this line if we were doing a multiply imputed analysis
dat_for_analysis_elig <- dat_for_analysis_elig %>% mutate(eligibility = if_else(logical_vec_cc, eligibility, 0))
```

```{r}
dat_for_analysis <- rbind(dat_for_analysis_elig, dat_for_analysis_not_elig)
dat_for_analysis <- dat_for_analysis %>% arrange(participant_id, decision_point)
dat_for_analysis <- dat_for_analysis %>% replace_na(my_list)
```

```{r}
participants_fully_dropped <- dat_for_analysis %>% 
  group_by(participant_id) %>% 
  summarise(count_elig = sum(eligibility)) %>%
  arrange(count_elig) %>%
  filter(count_elig == 0) %>%
  .[["participant_id"]]

if(length(participants_fully_dropped) > 0){
  dat_for_analysis <- dat_for_analysis %>% filter(!(participant_id %in% participants_fully_dropped))
}
```

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ income_val,  
  control_formula = ~ age + is_male + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_response_2qs + any_recent_eligible_dp + engagement_most_recent_eligible, 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)
```

```{r}
fit <- fit1

dat_result_causal <- summary(fit, show_control_fit = TRUE)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE)[["control_variables"]]

dat_result <- rbind(dat_result_causal, dat_result_control)

dat_result_causal <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["control_variables"]]
dat_result2 <- rbind(dat_result_causal, dat_result_control)
dat_result2 <- dat_result2[, c("90% LCL", "90% UCL")]
dat_result <- cbind(dat_result, dat_result2)

these_row_names <- rownames(dat_result)
dat_result <- as.data.frame(dat_result)
dat_result <- dat_result %>% select(Estimate, StdErr, `95% LCL`, `95% UCL`, `90% LCL`, `90% UCL`, everything()) 
dat_result <- as.matrix(dat_result)
row.names(dat_result) <- these_row_names

# Format output to 3 decimal places
dat_result %>% round(., 3) %>% format(., nsmall = 3) %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "other-exploratory-moderators", "log_risk_ratio_scale_income_val.csv"), row.names = TRUE)
```

# Cigarette availability self-reported in brief survey

```{r}
use_these_moderators <- c("cig_available")
```

```{r}
dat_for_analysis <- dat_primary_aim
```

```{r}
logical_vec_cc <- dat_for_analysis %>% 
  select(Y, eligibility,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)

dat_summary_observed <- dat_for_analysis %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1) %>%
  group_by(is_complete) %>%
  summarise(total = n())

n_participants_included_among_elig <- dat_for_analysis %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1 & is_complete == 1) %>% 
  summarise(total = length(unique(participant_id))) %>%
  .[["total"]]

n_participants_elig <- dat_for_analysis %>%
  filter(eligibility == 1) %>%
  .[["participant_id"]] %>%
  unique(.) %>%
  length(.)

n_participants_excluded_among_elig <- n_participants_elig - n_participants_included_among_elig

dat_summary <- data.frame(n_participants_elig = n_participants_elig,
                          n_participants_included_among_elig = n_participants_included_among_elig,
                          n_participants_excluded_among_elig = n_participants_excluded_among_elig,
                          n_elig = sum(dat_summary_observed[["total"]]),
                          n_included_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == TRUE, ][["total"]],
                          n_excluded_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == FALSE, ][["total"]])

dat_summary
```


```{r}
dat_for_analysis_elig <- dat_for_analysis %>% filter(eligibility == 1)
dat_for_analysis_not_elig <- dat_for_analysis %>% filter(eligibility == 0)
```

```{r}
logical_vec_cc <- dat_for_analysis_elig %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val,
         all_of(use_these_moderators)) %>%
  complete.cases(.)
```

```{r}
# Note that this line is needed because we are doing a complete case analysis
# We would not need this line if we were doing a multiply imputed analysis
dat_for_analysis_elig <- dat_for_analysis_elig %>% mutate(eligibility = if_else(logical_vec_cc, eligibility, 0))
```

```{r}
dat_for_analysis <- rbind(dat_for_analysis_elig, dat_for_analysis_not_elig)
dat_for_analysis <- dat_for_analysis %>% arrange(participant_id, decision_point)
dat_for_analysis <- dat_for_analysis %>% replace_na(my_list)
```

```{r}
participants_fully_dropped <- dat_for_analysis %>% 
  group_by(participant_id) %>% 
  summarise(count_elig = sum(eligibility)) %>%
  arrange(count_elig) %>%
  filter(count_elig == 0) %>%
  .[["participant_id"]]

if(length(participants_fully_dropped) > 0){
  dat_for_analysis <- dat_for_analysis %>% filter(!(participant_id %in% participants_fully_dropped))
}
```

## Estimated effect on the log-risk ratio scale

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ cig_available,  
  control_formula = ~ age + is_male + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_recent_eligible_dp + engagement_most_recent_eligible + cig_available, 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)

# Note: removed any_response_2qs in the control variables since the value of this variable will be 1 for all blocks included in complete case analysis.
```

```{r}
Lmat <- matrix(c(1,0,
                 1,1), nrow = 2, byrow = TRUE)

fit <- fit1

dat_result_causal <- summary(fit, show_control_fit = TRUE, lincomb = Lmat)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE, lincomb = Lmat)[["control_variables"]]

dat_result <- rbind(dat_result_causal, dat_result_control)

dat_result_causal <- summary(fit, show_control_fit = TRUE, conf_level = 0.90, lincomb = Lmat)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE, conf_level = 0.90, lincomb = Lmat)[["control_variables"]]
dat_result2 <- rbind(dat_result_causal, dat_result_control)
dat_result2 <- dat_result2[, c("90% LCL", "90% UCL")]
dat_result <- cbind(dat_result, dat_result2)

these_row_names <- rownames(dat_result)
dat_result <- as.data.frame(dat_result)
dat_result <- dat_result %>% select(Estimate, StdErr, `95% LCL`, `95% UCL`, `90% LCL`, `90% UCL`, everything()) 
dat_result <- as.matrix(dat_result)
row.names(dat_result) <- these_row_names

# Format output to 3 decimal places
dat_result %>% round(., 3) %>% format(., nsmall = 3) %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "other-exploratory-moderators", "log_risk_ratio_scale_cig_available.csv"), row.names = TRUE)
```

## Estimated effect on the risk ratio scale

```{r}
exp_estimates <- exp(dat_result[,"Estimate"])

rrLB95 <- exp(dat_result[,"95% LCL"])
rrUB95 <- exp(dat_result[,"95% UCL"])

rrLB90 <- exp(dat_result[,"90% LCL"])
rrUB90 <- exp(dat_result[,"90% UCL"])
```

```{r}
dat_result_exp <- data.frame(variable = row.names(dat_result),
                             exp_estimates = exp_estimates,
                             rrLB95 = rrLB95, rrUB95 = rrUB95,
                             rrLB90 = rrLB90, rrUB90 = rrUB90)
```

```{r}
dat_result_exp
```

```{r}
dat_result_exp_output <- dat_result_exp

dat_result_exp_output[,2:ncol(dat_result_exp_output)] <- format(round(dat_result_exp_output[,2:ncol(dat_result_exp_output)], 3), nsmall = 3)

dat_result_exp_output %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "other-exploratory-moderators", "risk_ratio_scale_cig_available.csv"), row.names = TRUE)
```

```{r}
png(file = file.path("analysis-complete-case", "formatted-output", "other-exploratory-moderators", "risk_ratio_scale_cig_available_CI95.png"), width = 7, height = 7, units = "in", res = 600)

dat_plot <- dat_result_exp[3:4,]
dat_plot$variable <- c("Cigarettes were not available", "Cigarettes were available")

plot("n", xlim = c(0,4), ylim = c(0.75,1.75), xlab = "", xaxt = "n", yaxt = "n", ylab = "Treatment Effect on the Risk Ratio Scale")
axis(1, at = c(1,3), labels = dat_plot$variable)
axis(2, at = seq(0.75,1.75,0.25))

use_x0 <- 1
use_y0 <- dat_plot$rrLB95[1]
use_y1 <- dat_plot$rrUB95[1]
points(use_x0, dat_plot$exp_estimates[1], col = "forestgreen", lwd = 30)
arrows(x0 = use_x0, y0 = use_y0, x1 = use_x0, y1 = use_y1, code = 3, col = "forestgreen", lwd = 10, angle = 90)
text(x = use_x0 + 0.5, y = dat_plot$exp_estimates[1], labels = round(dat_plot$exp_estimates[1], 3), col = "forestgreen", cex = 2)

use_x0 <- 3
use_y0 <- dat_plot$rrLB95[2]
use_y1 <- dat_plot$rrUB95[2]
points(use_x0, dat_plot$exp_estimates[2], col = "darkgoldenrod", lwd = 30)
arrows(x0 = use_x0, y0 = use_y0, x1 = use_x0, y1 = use_y1, code = 3, col = "darkgoldenrod", lwd = 10, angle = 90)
text(x = use_x0 + 0.5, y = dat_plot$exp_estimates[2], labels = round(dat_plot$exp_estimates[2], 3), col = "darkgoldenrod", cex = 2)

abline(h = 1, lty = 3, col = "red", lwd = 2)

dev.off()
```

```{r}
png(file = file.path("analysis-complete-case", "formatted-output", "other-exploratory-moderators", "risk_ratio_scale_cig_available_CI90.png"), width = 7, height = 7, units = "in", res = 600)

dat_plot <- dat_result_exp[3:4,]
dat_plot$variable <- c("Cigarettes were not available", "Cigarettes were available")

plot("n", xlim = c(0,4), ylim = c(0.75,1.75), xlab = "", xaxt = "n", yaxt = "n", ylab = "Treatment Effect on the Risk Ratio Scale")
axis(1, at = c(1,3), labels = dat_plot$variable)
axis(2, at = seq(0.75,1.75,0.25))

use_x0 <- 1
use_y0 <- dat_plot$rrLB90[1]
use_y1 <- dat_plot$rrUB90[1]
points(use_x0, dat_plot$exp_estimates[1], col = "forestgreen", lwd = 30)
arrows(x0 = use_x0, y0 = use_y0, x1 = use_x0, y1 = use_y1, code = 3, col = "forestgreen", lwd = 10, angle = 90)
text(x = use_x0 + 0.5, y = dat_plot$exp_estimates[1], labels = round(dat_plot$exp_estimates[1], 3), col = "forestgreen", cex = 2)

use_x0 <- 3
use_y0 <- dat_plot$rrLB90[2]
use_y1 <- dat_plot$rrUB90[2]
points(use_x0, dat_plot$exp_estimates[2], col = "darkgoldenrod", lwd = 30)
arrows(x0 = use_x0, y0 = use_y0, x1 = use_x0, y1 = use_y1, code = 3, col = "darkgoldenrod", lwd = 10, angle = 90)
text(x = use_x0 + 0.5, y = dat_plot$exp_estimates[2], labels = round(dat_plot$exp_estimates[2], 3), col = "darkgoldenrod", cex = 2)

abline(h = 1, lty = 3, col = "red", lwd = 2)

dev.off()
```

# Negative affect self-reported in brief survey

```{r}
use_these_moderators <- c("negative_affect")
```

```{r}
dat_for_analysis <- dat_primary_aim
```

```{r}
logical_vec_cc <- dat_for_analysis %>% 
  select(Y, eligibility,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)

dat_summary_observed <- dat_for_analysis %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1) %>%
  group_by(is_complete) %>%
  summarise(total = n())

n_participants_included_among_elig <- dat_for_analysis %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1 & is_complete == 1) %>% 
  summarise(total = length(unique(participant_id))) %>%
  .[["total"]]

n_participants_elig <- dat_for_analysis %>%
  filter(eligibility == 1) %>%
  .[["participant_id"]] %>%
  unique(.) %>%
  length(.)

n_participants_excluded_among_elig <- n_participants_elig - n_participants_included_among_elig

dat_summary <- data.frame(n_participants_elig = n_participants_elig,
                          n_participants_included_among_elig = n_participants_included_among_elig,
                          n_participants_excluded_among_elig = n_participants_excluded_among_elig,
                          n_elig = sum(dat_summary_observed[["total"]]),
                          n_included_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == TRUE, ][["total"]],
                          n_excluded_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == FALSE, ][["total"]])

dat_summary
```

```{r}
dat_for_analysis_elig <- dat_for_analysis %>% filter(eligibility == 1)
dat_for_analysis_not_elig <- dat_for_analysis %>% filter(eligibility == 0)
```

```{r}
logical_vec_cc <- dat_for_analysis_elig %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val,
         all_of(use_these_moderators)) %>%
  complete.cases(.)
```

```{r}
# Note that this line is needed because we are doing a complete case analysis
# We would not need this line if we were doing a multiply imputed analysis
dat_for_analysis_elig <- dat_for_analysis_elig %>% mutate(eligibility = if_else(logical_vec_cc, eligibility, 0))
```

```{r}
dat_for_analysis <- rbind(dat_for_analysis_elig, dat_for_analysis_not_elig)
dat_for_analysis <- dat_for_analysis %>% arrange(participant_id, decision_point)
dat_for_analysis <- dat_for_analysis %>% replace_na(my_list)
```

```{r}
participants_fully_dropped <- dat_for_analysis %>% 
  group_by(participant_id) %>% 
  summarise(count_elig = sum(eligibility)) %>%
  arrange(count_elig) %>%
  filter(count_elig == 0) %>%
  .[["participant_id"]]

if(length(participants_fully_dropped) > 0){
  dat_for_analysis <- dat_for_analysis %>% filter(!(participant_id %in% participants_fully_dropped))
}
```

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ negative_affect,  
  control_formula = ~ age + is_male + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_recent_eligible_dp + engagement_most_recent_eligible + negative_affect, 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)

# Note: removed any_response_2qs in the control variables since the value of this variable will be 1 for all blocks included in complete case analysis.
```

```{r}
Lmat <- matrix(c(1,0,
                 1,1), nrow = 2, byrow = TRUE)

fit <- fit1

dat_result_causal <- summary(fit, show_control_fit = TRUE, lincomb = Lmat)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE, lincomb = Lmat)[["control_variables"]]

dat_result <- rbind(dat_result_causal, dat_result_control)

dat_result_causal <- summary(fit, show_control_fit = TRUE, lincomb = Lmat, conf_level = 0.90)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE, lincomb = Lmat, conf_level = 0.90)[["control_variables"]]
dat_result2 <- rbind(dat_result_causal, dat_result_control)
dat_result2 <- dat_result2[, c("90% LCL", "90% UCL")]
dat_result <- cbind(dat_result, dat_result2)

these_row_names <- rownames(dat_result)
dat_result <- as.data.frame(dat_result)
dat_result <- dat_result %>% select(Estimate, StdErr, `95% LCL`, `95% UCL`, `90% LCL`, `90% UCL`, everything()) 
dat_result <- as.matrix(dat_result)
row.names(dat_result) <- these_row_names

# Format output to 3 decimal places
dat_result %>% round(., 3) %>% format(., nsmall = 3) %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "other-exploratory-moderators", "log_risk_ratio_scale_negative_affect.csv"), row.names = TRUE)
```

## Estimated effect on the risk ratio scale

```{r}
exp_estimates <- exp(dat_result[,"Estimate"])

rrLB95 <- exp(dat_result[,"95% LCL"])
rrUB95 <- exp(dat_result[,"95% UCL"])

rrLB90 <- exp(dat_result[,"90% LCL"])
rrUB90 <- exp(dat_result[,"90% UCL"])
```

```{r}
dat_result_exp <- data.frame(variable = row.names(dat_result),
                             exp_estimates = exp_estimates,
                             rrLB95 = rrLB95, rrUB95 = rrUB95,
                             rrLB90 = rrLB90, rrUB90 = rrUB90)
```

```{r}
dat_result_exp
```

```{r}
dat_result_exp_output <- dat_result_exp

dat_result_exp_output[,2:ncol(dat_result_exp_output)] <- format(round(dat_result_exp_output[,2:ncol(dat_result_exp_output)], 3), nsmall = 3)

dat_result_exp_output %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "other-exploratory-moderators", "risk_ratio_scale_negative_affect.csv"), row.names = TRUE)
```

```{r}
png(file = file.path("analysis-complete-case", "formatted-output", "other-exploratory-moderators", "risk_ratio_scale_negative_affect_CI95.png"), width = 7, height = 7, units = "in", res = 600)

dat_plot <- dat_result_exp[3:4,]
dat_plot$variable <- c("Negative emotions\nwere not present", "Negative emotions\nwere present")

plot("n", xlim = c(0,4), ylim = c(0.75,1.75), xlab = "", xaxt = "n", yaxt = "n", ylab = "Treatment Effect on the Risk Ratio Scale")
axis(1, at = c(1,3), labels = dat_plot$variable)
axis(2, at = seq(0.75,1.75,0.25))

use_x0 <- 1
use_y0 <- dat_plot$rrLB95[1]
use_y1 <- dat_plot$rrUB95[1]
points(use_x0, dat_plot$exp_estimates[1], col = "forestgreen", lwd = 30)
arrows(x0 = use_x0, y0 = use_y0, x1 = use_x0, y1 = use_y1, code = 3, col = "forestgreen", lwd = 10, angle = 90)
text(x = use_x0 + 0.5, y = dat_plot$exp_estimates[1], labels = round(dat_plot$exp_estimates[1], 3), col = "forestgreen", cex = 2)

use_x0 <- 3
use_y0 <- dat_plot$rrLB95[2]
use_y1 <- dat_plot$rrUB95[2]
points(use_x0, dat_plot$exp_estimates[2], col = "darkgoldenrod", lwd = 30)
arrows(x0 = use_x0, y0 = use_y0, x1 = use_x0, y1 = use_y1, code = 3, col = "darkgoldenrod", lwd = 10, angle = 90)
text(x = use_x0 + 0.5, y = dat_plot$exp_estimates[2], labels = round(dat_plot$exp_estimates[2], 3), col = "darkgoldenrod", cex = 2)

abline(h = 1, lty = 3, col = "red", lwd = 2)

dev.off()
```

```{r}
png(file = file.path("analysis-complete-case", "formatted-output", "other-exploratory-moderators", "risk_ratio_scale_negative_affect_CI90.png"), width = 7, height = 7, units = "in", res = 600)

dat_plot <- dat_result_exp[3:4,]
dat_plot$variable <- c("Negative emotions\nwere not present", "Negative emotions\nwere present")

plot("n", xlim = c(0,4), ylim = c(0.75,1.75), xlab = "", xaxt = "n", yaxt = "n", ylab = "Treatment Effect on the Risk Ratio Scale")
axis(1, at = c(1,3), labels = dat_plot$variable)
axis(2, at = seq(0.75,1.75,0.25))

use_x0 <- 1
use_y0 <- dat_plot$rrLB90[1]
use_y1 <- dat_plot$rrUB90[1]
points(use_x0, dat_plot$exp_estimates[1], col = "forestgreen", lwd = 30)
arrows(x0 = use_x0, y0 = use_y0, x1 = use_x0, y1 = use_y1, code = 3, col = "forestgreen", lwd = 10, angle = 90)
text(x = use_x0 + 0.5, y = dat_plot$exp_estimates[1], labels = round(dat_plot$exp_estimates[1], 3), col = "forestgreen", cex = 2)

use_x0 <- 3
use_y0 <- dat_plot$rrLB90[2]
use_y1 <- dat_plot$rrUB90[2]
points(use_x0, dat_plot$exp_estimates[2], col = "darkgoldenrod", lwd = 30)
arrows(x0 = use_x0, y0 = use_y0, x1 = use_x0, y1 = use_y1, code = 3, col = "darkgoldenrod", lwd = 10, angle = 90)
text(x = use_x0 + 0.5, y = dat_plot$exp_estimates[2], labels = round(dat_plot$exp_estimates[2], 3), col = "darkgoldenrod", cex = 2)

abline(h = 1, lty = 3, col = "red", lwd = 2)

dev.off()
```

# Cigarette availability and negative affect self-reported in brief survey

```{r}
use_these_moderators <- c("cig_available", "negative_affect")
```

```{r}
dat_for_analysis <- dat_primary_aim
```

```{r}
logical_vec_cc <- dat_for_analysis %>% 
  select(Y, eligibility,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)

dat_summary_observed <- dat_for_analysis %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1) %>%
  group_by(is_complete) %>%
  summarise(total = n())

n_participants_included_among_elig <- dat_for_analysis %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1 & is_complete == 1) %>% 
  summarise(total = length(unique(participant_id))) %>%
  .[["total"]]

n_participants_elig <- dat_for_analysis %>%
  filter(eligibility == 1) %>%
  .[["participant_id"]] %>%
  unique(.) %>%
  length(.)

n_participants_excluded_among_elig <- n_participants_elig - n_participants_included_among_elig

dat_summary <- data.frame(n_participants_elig = n_participants_elig,
                          n_participants_included_among_elig = n_participants_included_among_elig,
                          n_participants_excluded_among_elig = n_participants_excluded_among_elig,
                          n_elig = sum(dat_summary_observed[["total"]]),
                          n_included_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == TRUE, ][["total"]],
                          n_excluded_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == FALSE, ][["total"]])

dat_summary
```

```{r}
dat_for_analysis_elig <- dat_for_analysis %>% filter(eligibility == 1)
dat_for_analysis_not_elig <- dat_for_analysis %>% filter(eligibility == 0)
```

```{r}
logical_vec_cc <- dat_for_analysis_elig %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val,
         all_of(use_these_moderators)) %>%
  complete.cases(.)
```

```{r}
# Note that this line is needed because we are doing a complete case analysis
# We would not need this line if we were doing a multiply imputed analysis
dat_for_analysis_elig <- dat_for_analysis_elig %>% mutate(eligibility = if_else(logical_vec_cc, eligibility, 0))
```

```{r}
dat_for_analysis <- rbind(dat_for_analysis_elig, dat_for_analysis_not_elig)
dat_for_analysis <- dat_for_analysis %>% arrange(participant_id, decision_point)
dat_for_analysis <- dat_for_analysis %>% replace_na(my_list)
```

```{r}
participants_fully_dropped <- dat_for_analysis %>% 
  group_by(participant_id) %>% 
  summarise(count_elig = sum(eligibility)) %>%
  arrange(count_elig) %>%
  filter(count_elig == 0) %>%
  .[["participant_id"]]

if(length(participants_fully_dropped) > 0){
  dat_for_analysis <- dat_for_analysis %>% filter(!(participant_id %in% participants_fully_dropped))
}
```

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ cig_available + negative_affect + I(cig_available * negative_affect),  
  control_formula = ~ age + is_male + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_recent_eligible_dp + engagement_most_recent_eligible +  cig_available + negative_affect + I(cig_available * negative_affect), 
  availability = "eligibility"
)

Lmat <- rbind(c(1,0,0,0), # cigarettes were not available and negative emotions were not present
              c(1,0,1,0), # cigarettes were not available and negative emotions were present
              c(1,1,0,0), # cigarettes were available and negative emotions were not present
              c(1,1,1,1)) # cigarettes were available and negative emotions were present

# Note: removed any_response_2qs in the control variables since the value of this variable will be 1 for all blocks included in complete case analysis.
```

```{r}
fit <- fit1

dat_result_causal <- summary(fit, show_control_fit = TRUE, lincomb = Lmat)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE, lincomb = Lmat)[["control_variables"]]

dat_result <- rbind(dat_result_causal, dat_result_control)

dat_result_causal <- summary(fit, show_control_fit = TRUE, lincomb = Lmat, conf_level = 0.90)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE, lincomb = Lmat, conf_level = 0.90)[["control_variables"]]
dat_result2 <- rbind(dat_result_causal, dat_result_control)
dat_result2 <- dat_result2[, c("90% LCL", "90% UCL")]
dat_result <- cbind(dat_result, dat_result2)

these_row_names <- rownames(dat_result)
dat_result <- as.data.frame(dat_result)
dat_result <- dat_result %>% select(Estimate, StdErr, `95% LCL`, `95% UCL`, `90% LCL`, `90% UCL`, everything()) 
dat_result <- as.matrix(dat_result)
row.names(dat_result) <- these_row_names

# Format output to 3 decimal places
dat_result %>% round(., 3) %>% format(., nsmall = 3) %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "other-exploratory-moderators", "log_risk_ratio_scale_cig_available_and_negative_affect.csv"), row.names = TRUE)
```

## Estimated effect on the log-risk ratio scale

```{r}
dat_result
```

## Estimated effect on the risk ratio scale


```{r}
exp_estimates <- exp(dat_result[,"Estimate"])

rrLB95 <- exp(dat_result[,"95% LCL"])
rrUB95 <- exp(dat_result[,"95% UCL"])

rrLB90 <- exp(dat_result[,"90% LCL"])
rrUB90 <- exp(dat_result[,"90% UCL"])
```

```{r}
dat_result_exp <- data.frame(variable = row.names(dat_result),
                             exp_estimates = exp_estimates,
                             rrLB95 = rrLB95, rrUB95 = rrUB95,
                             rrLB90 = rrLB90, rrUB90 = rrUB90)
```

```{r}
dat_result_exp
```

```{r}
dat_result_exp_output <- dat_result_exp

dat_result_exp_output[,2:ncol(dat_result_exp_output)] <- format(round(dat_result_exp_output[,2:ncol(dat_result_exp_output)], 3), nsmall = 3)

dat_result_exp_output %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "other-exploratory-moderators", "risk_ratio_scale_cig_available_and_negative_affect.csv"), row.names = TRUE)
```


```{r}
png(file = file.path("analysis-complete-case", "formatted-output", "other-exploratory-moderators", "risk_ratio_scale_cig_available_and_negative_affect_CI95.png"), width = 14, height = 7, units = "in", res = 600)

dat_plot <- dat_result_exp[5:8,]
dat_plot$variable <- c("Cigarettes were not available and\nNegative emotions were not present", 
                       "Cigarettes were not available and\nNegative emotions were present",
                       "Cigarettes were available and\nNegative emotions were not present", 
                       "Cigarettes were available and\nNegative emotions were present")

plot("n", xlim = c(0,8), ylim = c(0.75,1.75), xlab = "", xaxt = "n", yaxt = "n", ylab = "Treatment Effect on the Risk Ratio Scale")
axis(1, at = c(1,3,5,7), labels = dat_plot$variable)
axis(2, at = seq(0.75,1.75,0.25))

use_x0 <- 1
use_y0 <- dat_plot$rrLB95[1]
use_y1 <- dat_plot$rrUB95[1]
points(use_x0, dat_plot$exp_estimates[1], col = "goldenrod1", lwd = 30)
arrows(x0 = use_x0, y0 = use_y0, x1 = use_x0, y1 = use_y1, code = 3, col = "goldenrod1", lwd = 10, angle = 90)
text(x = use_x0 + 0.5, y = dat_plot$exp_estimates[1], labels = round(dat_plot$exp_estimates[1], 3), col = "goldenrod1", cex = 2)

use_x0 <- 3
use_y0 <- dat_plot$rrLB95[2]
use_y1 <- dat_plot$rrUB95[2]
points(use_x0, dat_plot$exp_estimates[2], col = "darkorange", lwd = 30)
arrows(x0 = use_x0, y0 = use_y0, x1 = use_x0, y1 = use_y1, code = 3, col = "darkorange", lwd = 10, angle = 90)
text(x = use_x0 + 0.5, y = dat_plot$exp_estimates[2], labels = round(dat_plot$exp_estimates[2], 3), col = "darkorange", cex = 2)

use_x0 <- 5
use_y0 <- dat_plot$rrLB95[3]
use_y1 <- dat_plot$rrUB95[3]
points(use_x0, dat_plot$exp_estimates[3], col = "tomato", lwd = 30)
arrows(x0 = use_x0, y0 = use_y0, x1 = use_x0, y1 = use_y1, code = 3, col = "tomato", lwd = 10, angle = 90)
text(x = use_x0 + 0.5, y = dat_plot$exp_estimates[3], labels = round(dat_plot$exp_estimates[3], 3), col = "tomato", cex = 2)

use_x0 <- 7
use_y0 <- dat_plot$rrLB95[4]
use_y1 <- dat_plot$rrUB95[4]
points(use_x0, dat_plot$exp_estimates[4], col = "brown", lwd = 30)
arrows(x0 = use_x0, y0 = use_y0, x1 = use_x0, y1 = use_y1, code = 3, col = "brown", lwd = 10, angle = 90)
text(x = use_x0 + 0.5, y = dat_plot$exp_estimates[4], labels = round(dat_plot$exp_estimates[4], 3), col = "brown", cex = 2)

abline(h = 1, lty = 3, col = "red", lwd = 2)

dev.off()
```

```{r}
png(file = file.path("analysis-complete-case", "formatted-output", "other-exploratory-moderators", "risk_ratio_scale_cig_available_and_negative_affect_CI90.png"), width = 14, height = 7, units = "in", res = 600)

dat_plot <- dat_result_exp[5:8,]
dat_plot$variable <- c("Cigarettes were not available and\nNegative emotions were not present", 
                       "Cigarettes were not available and\nNegative emotions were present",
                       "Cigarettes were available and\nNegative emotions were not present", 
                       "Cigarettes were available and\nNegative emotions were present")

plot("n", xlim = c(0,8), ylim = c(0.75,1.75), xlab = "", xaxt = "n", yaxt = "n", ylab = "Treatment Effect on the Risk Ratio Scale")
axis(1, at = c(1,3,5,7), labels = dat_plot$variable)
axis(2, at = seq(0.75,1.75,0.25))

use_x0 <- 1
use_y0 <- dat_plot$rrLB90[1]
use_y1 <- dat_plot$rrUB90[1]
points(use_x0, dat_plot$exp_estimates[1], col = "goldenrod1", lwd = 30)
arrows(x0 = use_x0, y0 = use_y0, x1 = use_x0, y1 = use_y1, code = 3, col = "goldenrod1", lwd = 10, angle = 90)
text(x = use_x0 + 0.5, y = dat_plot$exp_estimates[1], labels = round(dat_plot$exp_estimates[1], 3), col = "goldenrod1", cex = 2)

use_x0 <- 3
use_y0 <- dat_plot$rrLB90[2]
use_y1 <- dat_plot$rrUB90[2]
points(use_x0, dat_plot$exp_estimates[2], col = "darkorange", lwd = 30)
arrows(x0 = use_x0, y0 = use_y0, x1 = use_x0, y1 = use_y1, code = 3, col = "darkorange", lwd = 10, angle = 90)
text(x = use_x0 + 0.5, y = dat_plot$exp_estimates[2], labels = round(dat_plot$exp_estimates[2], 3), col = "darkorange", cex = 2)

use_x0 <- 5
use_y0 <- dat_plot$rrLB90[3]
use_y1 <- dat_plot$rrUB90[3]
points(use_x0, dat_plot$exp_estimates[3], col = "tomato", lwd = 30)
arrows(x0 = use_x0, y0 = use_y0, x1 = use_x0, y1 = use_y1, code = 3, col = "tomato", lwd = 10, angle = 90)
text(x = use_x0 + 0.5, y = dat_plot$exp_estimates[3], labels = round(dat_plot$exp_estimates[3], 3), col = "tomato", cex = 2)

use_x0 <- 7
use_y0 <- dat_plot$rrLB90[4]
use_y1 <- dat_plot$rrUB90[4]
points(use_x0, dat_plot$exp_estimates[4], col = "brown", lwd = 30)
arrows(x0 = use_x0, y0 = use_y0, x1 = use_x0, y1 = use_y1, code = 3, col = "brown", lwd = 10, angle = 90)
text(x = use_x0 + 0.5, y = dat_plot$exp_estimates[4], labels = round(dat_plot$exp_estimates[4], 3), col = "brown", cex = 2)

abline(h = 1, lty = 3, col = "red", lwd = 2)

dev.off()
```

```{r}
if(file.exists("analysis-complete-case/formatted-output/other-exploratory-moderators/Thumbs.db")){
  file.remove("analysis-complete-case/formatted-output/other-exploratory-moderators/Thumbs.db")
}
```

