---
title: "MARS MRT: Block-Level Analyses"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document:
    toc: TRUE
    toc_depth: 4
    number_sections: TRUE
---

```{=html}
<style type="text/css">
.main-container {
  max-width: 1800px !important;
  margin-left: auto;
  margin-right: auto;
}
</style>
```

```{r global_options, include=FALSE}
knitr::opts_chunk$set(tidy = TRUE)
knitr::opts_chunk$set(fig.pos = 'H')
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)
options(width = 7000)
```

```{r}
source("paths.R")
library(knitr)
library(tidyverse)
library(geepack)
library(tvem)
```

```{r}
is_dir_exist <- file.exists(file.path("analysis-complete-case", "formatted-output"))

if(isFALSE(is_dir_exist)){
  dir.create(file.path("analysis-complete-case", "formatted-output"))
}

is_dir_exist <- file.exists(file.path("analysis-complete-case", "formatted-output", "Exploratory-Analysis-Associational-Nicotine-Use"))

if(isFALSE(is_dir_exist)){
  dir.create(file.path("analysis-complete-case", "formatted-output", "Exploratory-Analysis-Associational-Nicotine-Use"))
}
```

```{r}
dat_primary_aim <- readRDS(file = file.path(path_manipulated_data, "dat_primary_aim.rds"))
```

```{r}
dat_for_analysis <- dat_primary_aim %>%
  select(participant_id, cluster_id, decision_point, days_between_v1_and_coinflip_local,
         Y, substance_is_any_nicotine, eligibility, coinflip, is_high_effort, is_low_effort) %>% 
  mutate(coinflip = replace(coinflip, eligibility == 0, 0),
         is_high_effort = replace(is_high_effort, eligibility == 0, 0)) %>% 
  group_by(participant_id) %>% 
  mutate(substance_is_any_nicotine_lead1 = lead(substance_is_any_nicotine),
         eligibility_lead1 = lead(eligibility)) %>%
  ungroup(.) %>%
  filter((decision_point >= 7) & (decision_point <= 54))
```


# Marginal association between engagement in self-regulatory strategies and nicotine use on current person-block

$$
\mathrm{logit} Pr \left( S_{i,j} = 1 \Big| I_{i, j} = 1 \right) = \beta_0 + \beta_1 X_{i,j}
$$

```{r}
dat_logreg <- dat_for_analysis %>% 
  filter(eligibility == 1) %>% 
  select(participant_id, decision_point, substance_is_any_nicotine, Y) %>%
  mutate(drop_row = if_else(!complete.cases(.), 1, 0)) %>%
  filter(drop_row == 0)
```

```{r}
fit <- geeglm(substance_is_any_nicotine ~ Y, family = "binomial", data = dat_logreg, id = participant_id, waves = decision_point)
```

```{r}
dat_results <- summary(fit)[["coefficients"]]

dat_results[["LB95"]] <- dat_results$Estimate - qnorm(0.975) * dat_results$Std.err
dat_results[["UB95"]] <- dat_results$Estimate + qnorm(0.975) * dat_results$Std.err

dat_results[["LB90"]] <- dat_results$Estimate - qnorm(0.95) * dat_results$Std.err
dat_results[["UB90"]] <- dat_results$Estimate + qnorm(0.95) * dat_results$Std.err

dat_results_logodds_scale <- dat_results
dat_results_logodds_scale %>% round(., 3)

# Format output to 3 decimal places
dat_results_logodds_scale %>% round(., 3) %>% format(., nsmall = 3) %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "Exploratory-Analysis-Associational-Nicotine-Use", "block_level_log_odds_scale_concurrent.csv"), row.names = TRUE)
```

```{r}
dat_results_odds_scale <- data.frame(estimate = exp(dat_results$Estimate), 
                                     # 95% CI
                                     LB95 = exp(dat_results[["LB95"]]), 
                                     UB95 = exp(dat_results[["UB95"]]),
                                     # 90% CI
                                     LB90 = exp(dat_results[["LB90"]]), 
                                     UB90 = exp(dat_results[["UB90"]]))

row.names(dat_results_odds_scale) <- row.names(dat_results_logodds_scale)

dat_results_odds_scale %>% round(., 3)

# Format output to 3 decimal places
dat_results_odds_scale %>% round(., 3) %>% format(., nsmall = 3) %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "Exploratory-Analysis-Associational-Nicotine-Use", "block_level_odds_scale_concurrent.csv"), row.names = TRUE)
```

# Time-varying association between engagement in self-regulatory strategies and nicotine use on current person-block

$$
\text{logit} Pr\left(\text{ANY NICOTINE USE}_{i} \left(t_{i,j} \right) = 1\right)= \beta_0 \left(t_{i,j}\right) + \beta_1 \left(t_{i,j}\right) \text{WHETHER ENGAGED} \left(t_{i,j}\right)
$$
```{r}
dat_tvem <- dat_logreg
```

```{r}
list_collect_metrics <- list()

for(current_num_knots in 1:3){
  model_tvem <- tvem(data=dat_tvem,
                     formula=substance_is_any_nicotine ~ Y,
                     id=participant_id,
                     time=decision_point,
                     invar_effects=NULL,
                     family = binomial(),
                     num_knots = current_num_knots,
                     spline_order = 3,
                     penalty_function_order = 1,
                     penalize = TRUE)
  
  dat_current_metrics <- data.frame(total_knots = current_num_knots,
                                    penalty = 1,
                                    aic_value = model_tvem$model_information$pseudo_aic,
                                    bic_value = model_tvem$model_information$pseudo_bic)
  list_collect_metrics <- append(list_collect_metrics, list(dat_current_metrics))
}

dat_all_metrics <- bind_rows(list_collect_metrics)

model_tvem <- tvem(data=dat_tvem,
                   formula=substance_is_any_nicotine ~ Y,
                   id=participant_id,
                   time=decision_point,
                   invar_effects=NULL,
                   family = binomial(),
                   num_knots = dat_all_metrics[which.min(dat_all_metrics$bic_value),"total_knots"],
                   spline_order = 3,
                   penalty_function_order = 1,
                   penalize = TRUE)
```

```{r}
plot(model_tvem)
plot(model_tvem, exponentiate = TRUE)
```

```{r}
# Create ggplot version of plot
dat_fitted_tvem <- model_tvem$grid_fitted_coefficients$Y

dat_fitted_tvem[["time_grid"]] <- model_tvem$time_grid

dat_fitted_tvem[["UB95"]] <- model_tvem$grid_fitted_coefficients$Y$estimate + qnorm(0.975)*model_tvem$grid_fitted_coefficients$Y$standard_error
dat_fitted_tvem[["LB95"]] <- model_tvem$grid_fitted_coefficients$Y$estimate - qnorm(0.975)*model_tvem$grid_fitted_coefficients$Y$standard_error

dat_fitted_tvem[["UB90"]] <- model_tvem$grid_fitted_coefficients$Y$estimate + qnorm(0.95)*model_tvem$grid_fitted_coefficients$Y$standard_error
dat_fitted_tvem[["LB90"]] <- model_tvem$grid_fitted_coefficients$Y$estimate - qnorm(0.95)*model_tvem$grid_fitted_coefficients$Y$standard_error
```

```{r}
# Create ggplot version of plot
ggplot(dat_fitted_tvem, aes(time_grid, estimate)) + geom_line(linewidth = 2) + geom_ribbon(aes(ymin = LB95, ymax = UB95), alpha = 0.2, linetype = 2, linewidth = 2, color = "black", fill = "aquamarine4") + xlim(7,54) + xlab("Decision Point j") + ylab(expression(widehat(beta)[NU][paste(",")][1]*"(j)")) + geom_hline(yintercept = 0, color = "red", linewidth = 2, linetype = "dotted") + ggtitle("Black solid line: Estimate, Black dashed lines: 95% CI, Red dotted line depicts where estimate and 95% CI are in relation to 0") + scale_y_continuous(limits = c(-1, 0.6))

ggsave(filename = file.path("analysis-complete-case", "formatted-output", "Exploratory-Analysis-Associational-Nicotine-Use", "tvem_block_level_logodds_scale_concurrent_CI95.png"), dpi = 1000, units = "in", height = 7, width = 12)
```

```{r}
# Create ggplot version of plot
ggplot(dat_fitted_tvem, aes(time_grid, estimate)) + geom_line(linewidth = 2) + geom_ribbon(aes(ymin = LB90, ymax = UB90), alpha = 0.2, linetype = 2, linewidth = 2, color = "black", fill = "aquamarine4") + xlim(7,54) + xlab("Decision Point j") + ylab(expression(widehat(beta)[NU][paste(",")][1]*"(j)")) + geom_hline(yintercept = 0, color = "red", linewidth = 2, linetype = "dotted") + ggtitle("Black solid line: Estimate, Black dashed lines: 90% CI, Red dotted line depicts where estimate and 90% CI are in relation to 0") + scale_y_continuous(limits = c(-1, 0.6))

ggsave(filename = file.path("analysis-complete-case", "formatted-output", "Exploratory-Analysis-Associational-Nicotine-Use", "tvem_block_level_logodds_scale_concurrent_CI90.png"), dpi = 1000, units = "in", height = 7, width = 12)
```

```{r}
# Create ggplot version of plot
dat_fitted_tvem_exp_scale <- dat_fitted_tvem

dat_fitted_tvem_exp_scale[["estimate"]] <- exp(dat_fitted_tvem[["estimate"]])

dat_fitted_tvem_exp_scale[["UB95"]] <- exp(dat_fitted_tvem[["UB95"]])
dat_fitted_tvem_exp_scale[["LB95"]] <- exp(dat_fitted_tvem[["LB95"]])

dat_fitted_tvem_exp_scale[["UB90"]] <- exp(dat_fitted_tvem[["UB90"]])
dat_fitted_tvem_exp_scale[["LB90"]] <- exp(dat_fitted_tvem[["LB90"]])
```

```{r}
# Create ggplot version of plot
ggplot(dat_fitted_tvem_exp_scale, aes(time_grid, estimate)) + geom_line(linewidth = 2) + geom_ribbon(aes(ymin = LB95, ymax = UB95), alpha = 0.3, linetype = 2, linewidth = 2, color = "black", fill = "thistle3") + xlim(7,54) + xlab("Decision Point j") + ylab(expression("exp("*widehat(beta)[NU][paste(",")][1]*"(j))")) + geom_hline(yintercept = 1, color = "red", linewidth = 2, linetype = "dotted") + ggtitle("Black solid line: Estimate, Black dashed lines: 95% CI, Red dotted line depicts where estimate and 95% CI are in relation to 1") + scale_y_continuous(limits = c(0.5, 2))

ggsave(filename = file.path("analysis-complete-case", "formatted-output", "Exploratory-Analysis-Associational-Nicotine-Use", "tvem_block_level_odds_scale_concurrent_CI95.png"), dpi = 1000, units = "in", height = 7, width = 12)
```

```{r}
# Create ggplot version of plot
ggplot(dat_fitted_tvem_exp_scale, aes(time_grid, estimate)) + geom_line(linewidth = 2) + geom_ribbon(aes(ymin = LB90, ymax = UB90), alpha = 0.3, linetype = 2, linewidth = 2, color = "black", fill = "thistle3") + xlim(7,54) + xlab("Decision Point j") + ylab(expression("exp("*widehat(beta)[NU][paste(",")][1]*"(j))")) + geom_hline(yintercept = 1, color = "red", linewidth = 2, linetype = "dotted") + ggtitle("Black solid line: Estimate, Black dashed lines: 90% CI, Red dotted line depicts where estimate and 90% CI are in relation to 1") + scale_y_continuous(limits = c(0.5, 2))

ggsave(filename = file.path("analysis-complete-case", "formatted-output", "Exploratory-Analysis-Associational-Nicotine-Use", "tvem_block_level_odds_scale_concurrent_CI90.png"), dpi = 1000, units = "in", height = 7, width = 12)
```

# Marginal association between engagement in self-regulatory strategies and nicotine use on next person-block

$$
\mathrm{logit} Pr \left( S_{i,j + 1} = 1 \Big| \left\{I_{i, j} = 1\right\} \cap \left\{I_{i, j+1} = 1\right\} \right) = \beta_0 + \beta_1 S_{i, j} + \beta_2 \text{WHETHER ENGAGED}_{i,j} 
$$

```{r}
dat_logreg <- dat_for_analysis %>% 
  filter((eligibility == 1) & (eligibility_lead1 == 1)) %>% 
  select(participant_id, decision_point, substance_is_any_nicotine_lead1, substance_is_any_nicotine, Y) %>%
  mutate(drop_row = if_else(!complete.cases(.), 1, 0)) %>%
  filter(drop_row == 0)
```

```{r}
fit <- geeglm(substance_is_any_nicotine_lead1 ~ substance_is_any_nicotine + Y, family = "binomial", data = dat_logreg, id = participant_id, waves = decision_point)
```

```{r}
dat_results <- summary(fit)[["coefficients"]]

dat_results[["LB95"]] <- dat_results$Estimate - qnorm(0.975) * dat_results$Std.err
dat_results[["UB95"]] <- dat_results$Estimate + qnorm(0.975) * dat_results$Std.err

dat_results[["LB90"]] <- dat_results$Estimate - qnorm(0.95) * dat_results$Std.err
dat_results[["UB90"]] <- dat_results$Estimate + qnorm(0.95) * dat_results$Std.err

dat_results_logodds_scale <- dat_results
dat_results_logodds_scale %>% round(., 3)

# Format output to 3 decimal places
dat_results_logodds_scale %>% round(., 3) %>% format(., nsmall = 3) %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "Exploratory-Analysis-Associational-Nicotine-Use", "block_level_log_odds_scale_lagged.csv"), row.names = TRUE)
```

```{r}
dat_results_odds_scale <- data.frame(estimate = exp(dat_results$Estimate), 
                                     # 95% CI
                                     LB95 = exp(dat_results[["LB95"]]), 
                                     UB95 = exp(dat_results[["UB95"]]),
                                     # 90% CI
                                     LB90 = exp(dat_results[["LB90"]]), 
                                     UB90 = exp(dat_results[["UB90"]]))

row.names(dat_results_odds_scale) <- row.names(dat_results_logodds_scale)

dat_results_odds_scale %>% round(., 3)

# Format output to 3 decimal places
dat_results_odds_scale %>% round(., 3) %>% format(., nsmall = 3) %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "Exploratory-Analysis-Associational-Nicotine-Use", "block_level_odds_scale_lagged.csv"), row.names = TRUE)
```

# Time-varying association between engagement in self-regulatory strategies and nicotine use on next person-block

$$
\text{logit} Pr\left(\text{ANY NICOTINE USE}_{i} \left(t_{i,j+1} \right) = 1\right)= \beta_0 \left(t_{i,j}\right) + \beta_1 \left(t_{i,j}\right) \text{ANY NICOTINE USE}_{i} \left(t_{i,j} \right) + \beta_2 \left(t_{i,j}\right) \text{WHETHER ENGAGED} \left(t_{i,j}\right) 
$$
```{r}
dat_tvem <- dat_logreg
```

```{r}
list_collect_metrics <- list()

for(current_num_knots in 1:3){
  model_tvem <- tvem(data=dat_tvem,
                     formula=substance_is_any_nicotine_lead1 ~ substance_is_any_nicotine + Y,
                     id=participant_id,
                     time=decision_point,
                     invar_effects=NULL,
                     family = binomial(),
                     num_knots = current_num_knots,
                     spline_order = 3,
                     penalty_function_order = 1,
                     penalize = TRUE)
  
  dat_current_metrics <- data.frame(total_knots = current_num_knots,
                                    penalty = 1,
                                    aic_value = model_tvem$model_information$pseudo_aic,
                                    bic_value = model_tvem$model_information$pseudo_bic)
  list_collect_metrics <- append(list_collect_metrics, list(dat_current_metrics))
}

dat_all_metrics <- bind_rows(list_collect_metrics)

model_tvem <- tvem(data=dat_tvem,
                   formula=substance_is_any_nicotine_lead1 ~ substance_is_any_nicotine + Y,
                   id=participant_id,
                   time=decision_point,
                   invar_effects=NULL,
                   family = binomial(),
                   num_knots = dat_all_metrics[which.min(dat_all_metrics$bic_value),"total_knots"],
                   spline_order = 3,
                   penalty_function_order = 1,
                   penalize = TRUE)
```


```{r}
plot(model_tvem)
plot(model_tvem, exponentiate = TRUE)
```

```{r}
# Create ggplot version of plot
dat_fitted_tvem <- model_tvem$grid_fitted_coefficients$Y

dat_fitted_tvem[["time_grid"]] <- model_tvem$time_grid

dat_fitted_tvem[["UB95"]] <- model_tvem$grid_fitted_coefficients$Y$estimate + qnorm(0.975)*model_tvem$grid_fitted_coefficients$Y$standard_error
dat_fitted_tvem[["LB95"]] <- model_tvem$grid_fitted_coefficients$Y$estimate - qnorm(0.975)*model_tvem$grid_fitted_coefficients$Y$standard_error

dat_fitted_tvem[["UB90"]] <- model_tvem$grid_fitted_coefficients$Y$estimate + qnorm(0.95)*model_tvem$grid_fitted_coefficients$Y$standard_error
dat_fitted_tvem[["LB90"]] <- model_tvem$grid_fitted_coefficients$Y$estimate - qnorm(0.95)*model_tvem$grid_fitted_coefficients$Y$standard_error
```

```{r}
# Create ggplot version of plot
ggplot(dat_fitted_tvem, aes(time_grid, estimate)) + geom_line(linewidth = 2) + geom_ribbon(aes(ymin = LB95, ymax = UB95), alpha = 0.2, linetype = 2, linewidth = 2, color = "black", fill = "aquamarine4") + xlim(7,54) + xlab("Decision Point j") + ylab(expression(widehat(beta)[NU][paste(",")][2]*"(j)")) + geom_hline(yintercept = 0, color = "red", linewidth = 2, linetype = "dotted") + ggtitle("Black solid line: Estimate, Black dashed lines: 95% CI, Red dotted line depicts where estimate and 95% CI are in relation to 0") + scale_y_continuous(limits = c(-1, 0.6))

ggsave(filename = file.path("analysis-complete-case", "formatted-output", "Exploratory-Analysis-Associational-Nicotine-Use", "tvem_block_level_logodds_scale_lagged_CI95.png"), dpi = 1000, units = "in", height = 7, width = 12)
```

```{r}
# Create ggplot version of plot
ggplot(dat_fitted_tvem, aes(time_grid, estimate)) + geom_line(linewidth = 2) + geom_ribbon(aes(ymin = LB90, ymax = UB90), alpha = 0.2, linetype = 2, linewidth = 2, color = "black", fill = "aquamarine4") + xlim(7,54) + xlab("Decision Point j") + ylab(expression(widehat(beta)[NU][paste(",")][2]*"(j)")) + geom_hline(yintercept = 0, color = "red", linewidth = 2, linetype = "dotted") + ggtitle("Black solid line: Estimate, Black dashed lines: 90% CI, Red dotted line depicts where estimate and 90% CI are in relation to 0") + scale_y_continuous(limits = c(-1, 0.6))

ggsave(filename = file.path("analysis-complete-case", "formatted-output", "Exploratory-Analysis-Associational-Nicotine-Use", "tvem_block_level_logodds_scale_lagged_CI90.png"), dpi = 1000, units = "in", height = 7, width = 12)
```

```{r}
# Create ggplot version of plot
dat_fitted_tvem_exp_scale <- dat_fitted_tvem

dat_fitted_tvem_exp_scale[["estimate"]] <- exp(dat_fitted_tvem[["estimate"]])

dat_fitted_tvem_exp_scale[["UB95"]] <- exp(dat_fitted_tvem[["UB95"]])
dat_fitted_tvem_exp_scale[["LB95"]] <- exp(dat_fitted_tvem[["LB95"]])

dat_fitted_tvem_exp_scale[["UB90"]] <- exp(dat_fitted_tvem[["UB90"]])
dat_fitted_tvem_exp_scale[["LB90"]] <- exp(dat_fitted_tvem[["LB90"]])
```

```{r}
# Create ggplot version of plot
ggplot(dat_fitted_tvem_exp_scale, aes(time_grid, estimate)) + geom_line(linewidth = 2) + geom_ribbon(aes(ymin = LB95, ymax = UB95), alpha = 0.3, linetype = 2, linewidth = 2, color = "black", fill = "thistle3") + xlim(7,54) + xlab("Decision Point j") + ylab(expression("exp("*widehat(beta)[NU][paste(",")][2]*"(j))")) + geom_hline(yintercept = 1, color = "red", linewidth = 2, linetype = "dotted") + ggtitle("Black solid line: Estimate, Black dashed lines: 95% CI, Red dotted line depicts where estimate and 95% CI are in relation to 1") + scale_y_continuous(limits = c(0.5, 2))

ggsave(filename = file.path("analysis-complete-case", "formatted-output", "Exploratory-Analysis-Associational-Nicotine-Use", "tvem_block_level_odds_scale_lagged_CI95.png"), dpi = 1000, units = "in", height = 7, width = 12)
```

```{r}
# Create ggplot version of plot
ggplot(dat_fitted_tvem_exp_scale, aes(time_grid, estimate)) + geom_line(linewidth = 2) + geom_ribbon(aes(ymin = LB90, ymax = UB90), alpha = 0.3, linetype = 2, linewidth = 2, color = "black", fill = "thistle3") + xlim(7,54) + xlab("Decision Point j") + ylab(expression("exp("*widehat(beta)[NU][paste(",")][2]*"(j))")) + geom_hline(yintercept = 1, color = "red", linewidth = 2, linetype = "dotted") + ggtitle("Black solid line: Estimate, Black dashed lines: 90% CI, Red dotted line depicts where estimate and 90% CI are in relation to 1") + scale_y_continuous(limits = c(0.5, 2))

ggsave(filename = file.path("analysis-complete-case", "formatted-output", "Exploratory-Analysis-Associational-Nicotine-Use", "tvem_block_level_odds_scale_lagged_CI90.png"), dpi = 1000, units = "in", height = 7, width = 12)
```










