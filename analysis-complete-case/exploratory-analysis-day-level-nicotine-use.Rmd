---
title: "MARS MRT: Day-Level Analyses"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document:
    toc: TRUE
    toc_depth: 4
    number_sections: TRUE
---

```{=html}
<style type="text/css">
.main-container {
  max-width: 1800px !important;
  margin-left: auto;
  margin-right: auto;
}
</style>
```
```{r global_options, include=FALSE}
knitr::opts_chunk$set(tidy = TRUE)
knitr::opts_chunk$set(fig.pos = 'H')
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)
options(width = 7000)
```

```{r}
source("paths.R")
library(knitr)
library(tidyverse)
library(geepack)
library(tvem)
```

```{r}
is_dir_exist <- file.exists(file.path("analysis-complete-case", "formatted-output"))

if(isFALSE(is_dir_exist)){
  dir.create(file.path("analysis-complete-case", "formatted-output"))
}

is_dir_exist <- file.exists(file.path("analysis-complete-case", "formatted-output", "Exploratory-Analysis-Associational-Nicotine-Use"))

if(isFALSE(is_dir_exist)){
  dir.create(file.path("analysis-complete-case", "formatted-output", "Exploratory-Analysis-Associational-Nicotine-Use"))
}
```

```{r}
# This is the data frame that is the output of the very last step of our data pipeline
dat_primary_aim <- readRDS(file = file.path(path_manipulated_data, "dat_primary_aim.rds")) 
```

```{r}
dat_for_analysis <- dat_primary_aim %>%
  select(participant_id, cluster_id, decision_point,
         Y, substance_is_any_nicotine, eligibility, coinflip, is_high_effort, is_low_effort) %>%
  mutate(coinflip = replace(coinflip, eligibility == 0, 0),
         is_high_effort = replace(is_high_effort, eligibility == 0, 0)) %>%
  group_by(participant_id, cluster_id) %>%
  summarise(n_elig = sum(eligibility),
            n_any_prompt = sum(coinflip),
            n_high_effort_prompt = sum(is_high_effort),
            n_low_effort_prompt = sum(is_low_effort),
            n_obs_engaged = sum(!is.na(Y)),
            n_obs_nic = sum(!is.na(substance_is_any_nicotine)),
            n_engaged = sum(Y, na.rm = TRUE),
            n_nic = sum(substance_is_any_nicotine, na.rm = TRUE))
```

```{r}
dat_for_analysis <- dat_for_analysis %>%
  mutate(n_nic_lag1 = lag(n_nic),
         n_elig_lag1 = lag(n_elig),
         n_obs_nic_lag1 = lag(n_obs_nic),
         n_engaged_lag1 = lag(n_engaged)) %>%
  mutate(n_any_prompt_lag1 = lag(n_any_prompt),
         n_high_effort_prompt_lag1 = lag(n_high_effort_prompt),
         n_low_effort_prompt_lag1 = lag(n_low_effort_prompt)) %>%
  mutate(n_engaged_lag1_by_n_any_prompt = n_engaged_lag1 * n_any_prompt,
         n_engaged_lag1_by_n_high_effort_prompt = n_engaged_lag1 * n_high_effort_prompt) %>%
  mutate(n_obs_nic_lead1 = lead(n_obs_nic),
         n_nic_lead1 = lead(n_nic),
         n_elig_lead1 = lead(n_elig)) %>%
  mutate(any_nic = 1*(n_nic > 0),
         any_nic_lag1 = 1*(n_nic_lag1 > 0),
         any_nic_lead1 = 1*(n_nic_lead1 > 0)) %>%
  mutate(any_engaged = 1*(n_engaged > 0),
         any_engaged_lag1 = 1*(n_engaged_lag1 > 0)) %>%
  filter(cluster_id >= 2 & cluster_id <= 9)
```

# Marginal association between engagement in self-regulatory strategies and nicotine use on current day

$$
\mathrm{logit} Pr \left( S_{i,d} = 1 \Bigg| \sum_{b = 1}^6 I_{i, d, b} \geq 1 \right) = \beta_0 + \beta_1 X_{i,d}
$$

```{r}
dat_logreg <- dat_for_analysis %>% 
  filter(n_elig > 0) %>% 
  mutate(drop_row = if_else(n_elig != n_obs_nic, 1, 0)) %>%
  filter(drop_row == 0)
```

```{r}
fit <- geeglm(any_nic ~ n_engaged, family = "binomial", data = dat_logreg, id = participant_id, waves = cluster_id)
```

```{r}
dat_results <- summary(fit)[["coefficients"]]
dat_results[["LB95"]] <- dat_results$Estimate - qnorm(0.975) * dat_results$Std.err
dat_results[["UB95"]] <- dat_results$Estimate + qnorm(0.975) * dat_results$Std.err

dat_results_logodds_scale <- dat_results
dat_results_logodds_scale %>% round(., 3)

# Format output to 3 decimal places
dat_results_logodds_scale %>% round(., 3) %>% format(., nsmall = 3) %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "Exploratory-Analysis-Associational-Nicotine-Use", "day_level_log_odds_scale_concurrent.csv"), row.names = TRUE)
```

```{r}
dat_results_odds_scale <- data.frame(estimate = exp(dat_results$Estimate), LB95 = exp(dat_results[["LB95"]]), UB95 = exp(dat_results[["UB95"]]))
dat_results_odds_scale %>% round(., 3)

# Format output to 3 decimal places
dat_results_odds_scale %>% round(., 3) %>% format(., nsmall = 3) %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "Exploratory-Analysis-Associational-Nicotine-Use", "day_level_odds_scale_concurrent.csv"), row.names = TRUE)
```

# Estimate the prevalence

```{r}
dat_tvem <- dat_logreg
```

```{r}
list_collect_metrics <- list()

for(current_num_knots in 1:3){
  model_tvem <- tvem(data=dat_tvem,
                     formula=any_nic ~ 1,
                     id=participant_id,
                     time=n_engaged,
                     invar_effects=NULL,
                     family = binomial(),
                     num_knots = current_num_knots,
                     spline_order = 3,
                     penalty_function_order = 1,
                     penalize = TRUE)
  
  dat_current_metrics <- data.frame(total_knots = current_num_knots,
                                    penalty = 1,
                                    aic_value = model_tvem$model_information$pseudo_aic,
                                    bic_value = model_tvem$model_information$pseudo_bic)
  list_collect_metrics <- append(list_collect_metrics, list(dat_current_metrics))
}

dat_all_metrics <- bind_rows(list_collect_metrics)

model_tvem <- tvem(data=dat_tvem,
                   formula=any_nic ~ 1,
                   id=participant_id,
                   time=n_engaged,
                   invar_effects=NULL,
                   family = binomial(),
                   num_knots = dat_all_metrics[which.min(dat_all_metrics$bic_value),"total_knots"],
                   spline_order = 3,
                   penalty_function_order = 1,
                   penalize = TRUE)

#plot(model_tvem, exponentiate = TRUE)
```

```{r, fig.height = 5, fig.width = 7}
exp_est <- exp(model_tvem$grid_fitted_coefficients$`(Intercept)`[,"estimate"])
exp_upper <- exp(model_tvem$grid_fitted_coefficients$`(Intercept)`[,"upper"])
exp_lower <- exp(model_tvem$grid_fitted_coefficients$`(Intercept)`[,"lower"])

x_grid <- model_tvem$time_grid
prevalence <- exp_est/(1 + exp_est)
prevalence_upper <- exp_upper/(1 + exp_upper)
prevalence_lower <- exp_lower/(1 + exp_lower)
plot(x_grid, prevalence, ylim = c(0,1), type = "l", xlab = "No. of times engaged in self-regulatory strategies on day d", ylab = "Prevalance of nicotine use on day d")
lines(x_grid, prevalence_upper, type = "l", lty = 2)
lines(x_grid, prevalence_lower, type = "l", lty = 2)
```

# Time-varying association between engagement in self-regulatory strategies and nicotine use on current day

$$
\text{logit} Pr\left(\text{ANY NICOTINE USE}_{i} \left(t_{i,j} \right) = 1\right)= \beta_0 \left(t_{i,j}\right) + \beta_1 \left(t_{i,j}\right) \text{NO. OF TIMES ENGAGED} \left(t_{i,j}\right)
$$


```{r}
list_collect_metrics <- list()

for(current_num_knots in 1:3){
  model_tvem <- tvem(data=dat_tvem,
                     formula=any_nic ~ n_engaged,
                     id=participant_id,
                     time=cluster_id,
                     invar_effects=NULL,
                     family = binomial(),
                     num_knots = current_num_knots,
                     spline_order = 3,
                     penalty_function_order = 1,
                     penalize = TRUE)
  
  dat_current_metrics <- data.frame(total_knots = current_num_knots,
                                    penalty = 1,
                                    aic_value = model_tvem$model_information$pseudo_aic,
                                    bic_value = model_tvem$model_information$pseudo_bic)
  list_collect_metrics <- append(list_collect_metrics, list(dat_current_metrics))
}

dat_all_metrics <- bind_rows(list_collect_metrics)

model_tvem <- tvem(data=dat_tvem,
                   formula=any_nic ~ n_engaged,
                   id=participant_id,
                   time=cluster_id,
                   invar_effects=NULL,
                   family = binomial(),
                   num_knots = dat_all_metrics[which.min(dat_all_metrics$bic_value),"total_knots"],
                   spline_order = 3,
                   penalty_function_order = 1,
                   penalize = TRUE)

plot(model_tvem)
```

# Marginal association between engagement in self-regulatory strategies and nicotine use on next day

$$
\mathrm{logit} Pr \left( S_{i,d + 1} = 1 \Bigg| \left\{\sum_{b = 1}^6 I_{i,d, b} \geq 1\right\} \cap \left\{\sum_{b = 1}^6 I_{i,d+1, b} \geq 1\right\} \right) = \beta_0 + \beta_1 X_{i,d}
$$

```{r}
dat_logreg <- dat_for_analysis %>% 
  filter((n_elig > 0) & (n_elig_lead1 > 0)) %>% 
  mutate(drop_row = if_else((n_elig != n_obs_nic) | (n_elig_lead1 != n_obs_nic_lead1), 1, 0)) %>%
  filter(drop_row == 0)
```

```{r}
fit <- geeglm(any_nic_lead1 ~ n_engaged + any_nic, family = "binomial", data = dat_logreg, id = participant_id, waves = cluster_id)
```

```{r}
dat_results <- summary(fit)[["coefficients"]]
dat_results[["LB95"]] <- dat_results$Estimate - qnorm(0.975) * dat_results$Std.err
dat_results[["UB95"]] <- dat_results$Estimate + qnorm(0.975) * dat_results$Std.err

dat_results_logodds_scale <- dat_results
dat_results_logodds_scale %>% round(., 3)

# Format output to 3 decimal places
dat_results_logodds_scale %>% round(., 3) %>% format(., nsmall = 3) %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "Exploratory-Analysis-Associational-Nicotine-Use", "day_level_log_odds_scale_lagged.csv"), row.names = TRUE)
```

```{r}
dat_results_odds_scale <- data.frame(estimate = exp(dat_results$Estimate), LB95 = exp(dat_results[["LB95"]]), UB95 = exp(dat_results[["UB95"]]))
dat_results_odds_scale %>% round(., 3)

# Format output to 3 decimal places
dat_results_odds_scale %>% round(., 3) %>% format(., nsmall = 3) %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "Exploratory-Analysis-Associational-Nicotine-Use", "day_level_odds_scale_lagged.csv"), row.names = TRUE)
```

# Time-varying association between engagement in self-regulatory strategies and next day nicotine use

```{r}
dat_tvem <- dat_logreg
```

$$
\text{logit} Pr\left(\text{ANY NICOTINE USE}_{i} \left(t_{i,j+1} \right) = 1\right)= \beta_0 \left(t_{i,j}\right) + \beta_1 \left(t_{i,j}\right) \text{NO. OF TIMES ENGAGED} \left(t_{i,j}\right) + \beta_2 \left(t_{i,j}\right) \text{ANY NICOTINE USE}_{i} \left(t_{i,j}\right)
$$


```{r}
list_collect_metrics <- list()

for(current_num_knots in 1:3){
  model_tvem <- tvem(data=dat_tvem,
                     formula=any_nic_lead1 ~ n_engaged + any_nic,
                     id=participant_id,
                     time=cluster_id,
                     invar_effects=NULL,
                     family = binomial(),
                     num_knots = current_num_knots,
                     spline_order = 3,
                     penalty_function_order = 1,
                     penalize = TRUE)
  
  dat_current_metrics <- data.frame(total_knots = current_num_knots,
                                    penalty = 1,
                                    aic_value = model_tvem$model_information$pseudo_aic,
                                    bic_value = model_tvem$model_information$pseudo_bic)
  list_collect_metrics <- append(list_collect_metrics, list(dat_current_metrics))
}

dat_all_metrics <- bind_rows(list_collect_metrics)

model_tvem <- tvem(data=dat_tvem,
                   formula=any_nic_lead1 ~ n_engaged + any_nic,
                   id=participant_id,
                   time=cluster_id,
                   invar_effects=NULL,
                   family = binomial(),
                   num_knots = dat_all_metrics[which.min(dat_all_metrics$bic_value),"total_knots"],
                   spline_order = 3,
                   penalty_function_order = 1,
                   penalize = TRUE)

plot(model_tvem)
```


