---
title: "MARS MRT: H4"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document:
    toc: TRUE
    toc_depth: 4
    number_sections: TRUE
---

```{=html}
<style type="text/css">
.main-container {
  max-width: 1800px !important;
  margin-left: auto;
  margin-right: auto;
}
</style>
```
```{r global_options, include=FALSE}
knitr::opts_chunk$set(tidy = TRUE)
knitr::opts_chunk$set(fig.pos = 'H')
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)
options(width = 7000)
```

```{r}
source("paths.R")
library(knitr)
library(tidyverse)
library(tvem)
```

# Description of set up

## Variables included in the time-varying effect models (Tan, et al., 2012)

 A typical day in the study involves a 14-hour long data collection period subdivided into 6 contiguous 140-minute long **blocks** of time; our notation below operationalizes variables in terms of blocks.

* $\text{ENGAGEMENT}_{i} \left(t_{i,j}\right)$ denotes whether engagement in self-regulatory strategies was reported by participant $i$ in the EMA in block $j$ (1 = Yes; 0 = No)

* $\text{SMOKING}_{i} \left(t_{i,j}\right)$ denotes whether cigarette smoking was reported by participant $i$ in the EMA in block $j$ (1 = Yes; 0 = No)

* $\text{SMOKING}_{i} \left(t_{i,j+1}\right)$ denotes whether cigarette smoking was reported by participant $i$ in the EMA in block $j+1$ (1 = Yes; 0 = No)

## Defining time

* $t_{i,j}$ denotes the "time" at which block $j$ of person $i$ occurred. 
  - In this write-up, "time" is operationalized as block number: that is, $t_{i,j} = j$ and $j = 7, 8, 9, 10, ..., 53, 54$.
  - **Definition of TVEM "origin time" for all models:** The 7th block ($j=7$) which corresponds to the first block one day after the first clinic visit.
    - **Rationale:** Participants may complete their clinic visits at different times of the day. Hence, some participants do not have EMA in some blocks on the day of their first clinic visit simply because their first clinic visit was scheduled later in the day. Therefore, in order to have a definition of the TVEM "origin time" which would have a common interpretation for all participants, we define the TVEM "origin time" for all models to be the 7th block ($j=7$) which corresponds to the first block one day after the first clinic visit.

## References

Tan, X., Shiyko, M. P., Li, R., Li, Y., and Dierker, L. (2012). A time-varying effect model for intensive longitudinal data. Psychological methods, 17(1), 61.

# Results

```{r}
# This is the data frame that is the output of the very last step of our data pipeline
dat_primary_aim <- readRDS(file = file.path(path_manipulated_data, "dat_primary_aim.rds")) 
dat_primary_aim <- dat_primary_aim %>%
  # Note that in contrast to H1, in H3 there is no sensitivity analysis where we re-do the analyses using all 10 days of the MRT
  mutate(is_include_main = if_else((decision_point >= 7) & (decision_point <= 54), 1, 0))                                                    
```

```{r}
dat_primary_aim <- dat_primary_aim %>%
  group_by(mars_id) %>%
  mutate(eligibility_lead1 = lead(eligibility)) %>%
  mutate(eligibility_lead1 = replace(eligibility_lead1, decision_point == 60, 0)) %>%
  mutate(substance_is_any_nicotine_lead1 = lead(substance_is_any_nicotine)) %>%
  mutate(eligibility_overall_next_dp = if_else(eligibility == 1 & eligibility_lead1 == 1, 1, 0)) %>%
  ungroup(.)
```

```{r, echo = FALSE}
dat_for_analysis <- dat_primary_aim %>% filter(is_include_main == 1)
```

## Model 0

```{r}
dat_tvem <- dat_for_analysis %>% 
  filter(eligibility == 1) %>%
  filter(!is.na(substance_is_any_nicotine))
```


$$
\mathrm{logit}(Pr\left\{\text{SMOKING}_{i} \left(t_{i,j}\right) = 1\right\}) = \beta_0 \left(t_{i,j}\right)
$$

```{r}
list_collect_metrics <- list()

for(current_num_knots in 1:20){
  model_tvem <- tvem(data=dat_tvem,
                     formula=substance_is_any_nicotine ~ 1,
                     id=participant_id,
                     time=decision_point,
                     invar_effects=NULL,
                     family = binomial(),
                     num_knots = current_num_knots,
                     spline_order = 3,
                     penalty_function_order = 1,
                     penalize = TRUE)
  
  dat_current_metrics <- data.frame(total_knots = current_num_knots,
                                    penalty = 1,
                                    aic_value = model_tvem$model_information$pseudo_aic,
                                    bic_value = model_tvem$model_information$pseudo_bic)
  
  list_collect_metrics <- append(list_collect_metrics, list(dat_current_metrics))
}

dat_all_metrics <- bind_rows(list_collect_metrics)
```

```{r}
model_tvem_0 <- tvem(data=dat_tvem,
                     formula=substance_is_any_nicotine ~ 1,
                     id=participant_id,
                     time=decision_point,
                     invar_effects=NULL,
                     family = binomial(),
                     num_knots = dat_all_metrics[which.min(dat_all_metrics$bic_value),"total_knots"],
                     spline_order = 3,
                     penalty_function_order = 1,
                     penalize = TRUE)

#print(model_tvem_0)
plot(model_tvem_0, exponentiate = TRUE)
```

```{r}
dat_tvem <- dat_for_analysis %>% 
  filter(eligibility == 1) %>%
  filter(!is.na(Y)) %>%
  rename(engagement = Y)
```


$$
\mathrm{logit}(Pr\left\{\text{ENGAGEMENT}_{i} \left(t_{i,j}\right) = 1\right\}) = \beta_0 \left(t_{i,j}\right)
$$

```{r}
list_collect_metrics <- list()

for(current_num_knots in 1:20){
  model_tvem <- tvem(data=dat_tvem,
                     formula=engagement ~ 1,
                     id=participant_id,
                     time=decision_point,
                     invar_effects=NULL,
                     family = binomial(),
                     num_knots = current_num_knots,
                     spline_order = 3,
                     penalty_function_order = 1,
                     penalize = TRUE)
  
  dat_current_metrics <- data.frame(total_knots = current_num_knots,
                                    penalty = 1,
                                    aic_value = model_tvem$model_information$pseudo_aic,
                                    bic_value = model_tvem$model_information$pseudo_bic)
  
  list_collect_metrics <- append(list_collect_metrics, list(dat_current_metrics))
}

dat_all_metrics <- bind_rows(list_collect_metrics)
```


```{r}
model_tvem_0 <- tvem(data=dat_tvem,
                     formula=engagement ~ 1,
                     id=participant_id,
                     time=decision_point,
                     invar_effects=NULL,
                     family = binomial(),
                     num_knots = dat_all_metrics[which.min(dat_all_metrics$bic_value),"total_knots"],
                     spline_order = 3,
                     penalty_function_order = 1,
                     penalize = TRUE)

#print(model_tvem_0)
plot(model_tvem_0, exponentiate = TRUE)
```

## Model 1

```{r}
dat_tvem <- dat_for_analysis %>% 
  filter(eligibility == 1) %>%
  filter(!is.na(Y)) %>%
  filter(!is.na(substance_is_any_nicotine)) %>%
  rename(engagement = Y)
```


$$
\mathrm{logit}(Pr\left\{\text{SMOKING}_{i} \left(t_{i,j}\right) = 1\right\}) = \beta_0 \left(t_{i,j}\right) + \beta_1 \left(t_{i,j}\right) \text{ENGAGEMENT}_{i} \left(t_{i,j}\right)
$$

```{r}
list_collect_metrics <- list()

for(current_num_knots in 1:20){
  model_tvem <- tvem(data=dat_tvem,
                     formula=substance_is_any_nicotine ~ engagement,
                     id=participant_id,
                     time=decision_point,
                     invar_effects=NULL,
                     family = binomial(),
                     num_knots = current_num_knots,
                     spline_order = 3,
                     penalty_function_order = 1,
                     penalize = TRUE)
  
  dat_current_metrics <- data.frame(total_knots = current_num_knots,
                                    penalty = 1,
                                    aic_value = model_tvem$model_information$pseudo_aic,
                                    bic_value = model_tvem$model_information$pseudo_bic)
  
  list_collect_metrics <- append(list_collect_metrics, list(dat_current_metrics))
}

dat_all_metrics <- bind_rows(list_collect_metrics)
```


```{r}
model_tvem_1 <- tvem(data=dat_tvem,
                     formula=substance_is_any_nicotine ~ engagement,
                     id=participant_id,
                     time=decision_point,
                     invar_effects=NULL,
                     family = binomial(),
                     num_knots = dat_all_metrics[which.min(dat_all_metrics$bic_value),"total_knots"],
                     spline_order = 3,
                     penalty_function_order = 1,
                     penalize = TRUE)

#print(model_tvem_1)
plot(model_tvem_1, exponentiate = TRUE)
```

## Model 2a

```{r}
dat_tvem <- dat_for_analysis %>% 
  filter(eligibility_overall_next_dp == 1) %>%
  filter(!is.na(Y)) %>%
  filter(!is.na(substance_is_any_nicotine_lead1)) %>%
  rename(engagement = Y)
```


$$
\mathrm{logit}(Pr\left\{\text{SMOKING}_{i} \left(t_{i,j+1}\right) = 1\right\}) = \beta_0 \left(t_{i,j}\right) + \beta_1 \left(t_{i,j}\right) \text{ENGAGEMENT}_{i} \left(t_{i,j}\right)
$$

```{r}
list_collect_metrics <- list()

for(current_num_knots in 1:20){
  model_tvem <- tvem(data=dat_tvem,
                     formula=substance_is_any_nicotine_lead1 ~ engagement,
                     id=participant_id,
                     time=decision_point,
                     invar_effects=NULL,
                     family = binomial(),
                     num_knots = current_num_knots,
                     spline_order = 3,
                     penalty_function_order = 1,
                     penalize = TRUE)
  
  dat_current_metrics <- data.frame(total_knots = current_num_knots,
                                    penalty = 1,
                                    aic_value = model_tvem$model_information$pseudo_aic,
                                    bic_value = model_tvem$model_information$pseudo_bic)
  list_collect_metrics <- append(list_collect_metrics, list(dat_current_metrics))
}

dat_all_metrics <- bind_rows(list_collect_metrics)
```


```{r}
model_tvem_2a <- tvem(data=dat_tvem,
                      formula=substance_is_any_nicotine_lead1 ~ engagement,
                      id=participant_id,
                      time=decision_point,
                      invar_effects=NULL,
                      family = binomial(),
                      num_knots = dat_all_metrics[which.min(dat_all_metrics$bic_value),"total_knots"],
                      spline_order = 3,
                      penalty_function_order = 1,
                      penalize = TRUE)

#print(model_tvem_2a)
plot(model_tvem_2a, exponentiate = TRUE)
```


## Model 2b

```{r}
dat_tvem <- dat_for_analysis %>% 
  filter(eligibility_overall_next_dp == 1) %>%
  filter(!is.na(Y)) %>%
  filter(!is.na(substance_is_any_nicotine_lead1)) %>%
  filter(!is.na(substance_is_any_nicotine)) %>%
  rename(engagement = Y)
```


$$
\mathrm{logit}(Pr\left\{\text{SMOKING}_{i} \left(t_{i,j+1}\right) = 1\right\}) = \beta_0 \left(t_{i,j}\right) + \beta_1 \left(t_{i,j}\right) \text{ENGAGEMENT}_{i} \left(t_{i,j}\right) + \beta_2 \left(t_{i,j}\right) \text{SMOKING}_{i} \left(t_{i,j}\right)
$$


```{r}
list_collect_metrics <- list()

for(current_num_knots in 1:20){
  model_tvem <- tvem(data=dat_tvem,
                     formula=substance_is_any_nicotine_lead1 ~ engagement + substance_is_any_nicotine,
                     id=participant_id,
                     time=decision_point,
                     invar_effects=NULL,
                     family = binomial(),
                     num_knots = current_num_knots,
                     spline_order = 3,
                     penalty_function_order = 1,
                     penalize = TRUE)
  
  dat_current_metrics <- data.frame(total_knots = current_num_knots,
                                    penalty = 1,
                                    aic_value = model_tvem$model_information$pseudo_aic,
                                    bic_value = model_tvem$model_information$pseudo_bic)
  list_collect_metrics <- append(list_collect_metrics, list(dat_current_metrics))
}

dat_all_metrics <- bind_rows(list_collect_metrics)
```


```{r}
model_tvem_2b <- tvem(data=dat_tvem,
                      formula=substance_is_any_nicotine_lead1 ~ engagement + substance_is_any_nicotine,
                      id=participant_id,
                      time=decision_point,
                      invar_effects=NULL,
                      family = binomial(),
                      num_knots = dat_all_metrics[which.min(dat_all_metrics$bic_value),"total_knots"],
                      spline_order = 3,
                      penalty_function_order = 1,
                      penalize = TRUE)

#print(model_tvem_2b)
plot(model_tvem_2b, exponentiate = TRUE)
```




