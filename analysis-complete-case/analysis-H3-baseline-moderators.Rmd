---
title: "MARS MRT: H3 (baseline moderators)"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document:
    toc: TRUE
    toc_depth: 4
    number_sections: TRUE
---

```{=html}
<style type="text/css">
.main-container {
  max-width: 1800px !important;
  margin-left: auto;
  margin-right: auto;
}
</style>
```
```{r global_options, include=FALSE}
knitr::opts_chunk$set(tidy = TRUE)
knitr::opts_chunk$set(fig.pos = 'H')
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)
options(width = 7000)
```

```{r}
source("paths.R")
library(knitr)
library(tidyverse)
library(MRTAnalysis)
```

```{r}
is_dir_exist <- file.exists(file.path("analysis-complete-case", "formatted-output"))

if(isFALSE(is_dir_exist)){
  dir.create(file.path("analysis-complete-case", "formatted-output"))
}

is_dir_exist <- file.exists(file.path("analysis-complete-case", "formatted-output", "H3-baseline-moderators"))

if(isFALSE(is_dir_exist)){
  dir.create(file.path("analysis-complete-case", "formatted-output", "H3-baseline-moderators"))
}
```

```{r}
# This is the data frame that is the output of the very last step of our data pipeline
dat_primary_aim <- readRDS(file = file.path(path_manipulated_data, "dat_primary_aim.rds")) 
dat_primary_aim <- dat_primary_aim %>%
  # Note that in contrast to H1, in H3 there is no sensitivity analysis where we re-do the analyses using all 10 days of the MRT
  mutate(is_include_main = if_else((decision_point >= 7) & (decision_point <= 54), 1, 0))                                                    
```

```{r}
dat_primary_aim <- dat_primary_aim %>% filter(is_include_main == 1)
```

```{r}
my_list <- list(Y = -1,
                coinflip = -1,
                hour_coinflip_local = -1,
                days_between_v1_and_coinflip_local = -1,
                any_response_2qs = -1,
                any_recent_eligible_dp = -1,
                engagement_most_recent_eligible = -1,
                age = -1,
                is_male = -1,
                is_latino = -1,
                is_not_latino_and_black = -1,
                is_not_latino_and_other = -1,
                baseline_tobacco_history = -1,
                has_partner = -1,
                income_val = -1,
                # Baseline moderators
                srq_mean = -1,
                mdes_pos_mean = -1,
                mdes_neg_mean = -1,
                uclals_mean = -1,
                Nicotine_dep = -1, 
                phqa1_1 = -1, 
                phqa_problem = -1, 
                ecig_1 = -1, 
                ecig_2 = -1,
                ecig_3 = -1, 
                ecig_4 = -1, 
                maas_total = -1,
                FFMQ_total = -1,  
                ffmq_nonjudge = -1, 
                ffmq_aware = -1, 
                gratitude = -1)


# This is a masterlist of moderators we are using in this script
use_these_moderators <- c("srq_mean", # self-regulation: higher scores indicate higher self-regulation abilities
                          "mdes_pos_mean", # mdes: higher scores indicate more intense positive emotions
                          "mdes_neg_mean", # mdes: higher scores indicate more intense negative emotions
                          "uclals_mean", # loneliness: higher scores indicate a higher sense of loneliness
                          "Nicotine_dep", # heaviness of smoking: higher scores indicate higher smoking levels
                          "phqa1_1",  # have you ever drank alcohol (including beer or wine): 1 = yes, 0 = no
                          "phqa_problem",  # 0/1 indicator of whether the individual has a drinking problem: 1 = yes, 0 = no, -99 = phqa1_1 = 0
                          "ecig_1", # do you use any electronic nicotine delivery system like vape pen, JUUL, or ecigarettes: 1 = yes, 0 = no
                          "ecig_2", # during the past 30 days, how many days did you use a vape pen, JUUL, or ecigarette, even one or two puffs? number: min = 0; max = 30
                          "ecig_3", # on days you use a vape pen or JUUL, please estimate how many separate times per day you usually use it. number: min = 0; max = 500
                          "ecig_4",  # how many vape pen, JUUL, or ecigarette puffs on average do you take each time you use it? number: min = 0, max = 100
                          "maas_total", # mindfulness: higher scores indicate higher mindfulness
                          "FFMQ_total",  # mindfulness: higher scores indicate higher overall mindfulness
                          "ffmq_nonjudge",  # mindfulness: higher scores indicate higher non-judging of inner experiences
                          "ffmq_aware",  # mindfulness: higher scores indicate greater acting with awareness
                          "gratitude")
```

# Baseline moderators

## Self-Regulation

```{r}
use_these_moderators <- c("srq_mean")
```

```{r}
logical_vec_cc <- dat_primary_aim %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)

dat_summary_observed <- dat_primary_aim %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1) %>%
  group_by(is_complete) %>%
  summarise(total = n())

n_participants_included_among_elig <- dat_primary_aim %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1 & is_complete == 1) %>% 
  summarise(total = length(unique(participant_id))) %>%
  .[["total"]]

n_participants_elig <- dat_primary_aim %>%
  filter(eligibility == 1) %>%
  .[["participant_id"]] %>%
  unique(.) %>%
  length(.)

n_participants_excluded_among_elig <- n_participants_elig - n_participants_included_among_elig

dat_summary <- data.frame(n_participants_elig = n_participants_elig,
                          n_participants_included_among_elig = n_participants_included_among_elig,
                          n_participants_excluded_among_elig = n_participants_excluded_among_elig,
                          n_elig = sum(dat_summary_observed[["total"]]),
                          n_included_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == TRUE, ][["total"]],
                          n_excluded_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == FALSE, ][["total"]])

dat_summary
```

```{r}
dat_for_analysis <- dat_primary_aim %>%
  select(participant_id, decision_point, eligibility, 
         coinflip, Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val,
         all_of(use_these_moderators))
```

```{r}
dat_for_analysis_elig <- dat_for_analysis %>% filter(eligibility == 1)
dat_for_analysis_not_elig <- dat_for_analysis %>% filter(eligibility == 0)
```

```{r}
logical_vec_cc <- dat_for_analysis_elig %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)
```

```{r}
# Note that this line is needed because we are doing a complete case analysis
# We would not need this line if we were doing a multiply imputed analysis
dat_for_analysis_elig <- dat_for_analysis_elig %>% mutate(eligibility = if_else(logical_vec_cc, eligibility, 0))
```

```{r}
dat_for_analysis <- rbind(dat_for_analysis_elig, dat_for_analysis_not_elig)
dat_for_analysis <- dat_for_analysis %>% arrange(participant_id, decision_point)
dat_for_analysis <- dat_for_analysis %>% replace_na(my_list)
```

```{r}
participants_fully_dropped <- dat_for_analysis %>% 
  group_by(participant_id) %>% 
  summarise(count_elig = sum(eligibility)) %>%
  arrange(count_elig) %>%
  filter(count_elig == 0) %>%
  .[["participant_id"]]

if(length(participants_fully_dropped) > 0){
  dat_for_analysis <- dat_for_analysis %>% filter(!(participant_id %in% participants_fully_dropped))
}
```

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ srq_mean,  
  control_formula = ~ srq_mean + age + is_male + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_response_2qs + engagement_most_recent_eligible, 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)
```

```{r}
fit <- fit1

dat_result_causal <- summary(fit, show_control_fit = TRUE)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE)[["control_variables"]]
dat_result <- rbind(dat_result_causal, dat_result_control)

dat_result_causal <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["control_variables"]]
dat_result2 <- rbind(dat_result_causal, dat_result_control)
dat_result2 <- dat_result2[, c("90% LCL", "90% UCL")]

dat_result <- cbind(dat_result, dat_result2)
dat_result <- dat_result[, c("Estimate","StdErr","95% LCL","95% UCL","90% LCL","90% UCL","t_value","df","p-value")]

# Format output to 3 decimal places
dat_result %>% round(., 3) %>% format(., nsmall = 3) %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "H3-baseline-moderators", "log_risk_ratio_scale_H3_srq_mean.csv"), row.names = TRUE)
```

## Mental health -- mDES positive emotions

```{r}
use_these_moderators <- c("mdes_pos_mean")
```

```{r}
logical_vec_cc <- dat_primary_aim %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)

dat_summary_observed <- dat_primary_aim %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1) %>%
  group_by(is_complete) %>%
  summarise(total = n())

n_participants_included_among_elig <- dat_primary_aim %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1 & is_complete == 1) %>% 
  summarise(total = length(unique(participant_id))) %>%
  .[["total"]]

n_participants_elig <- dat_primary_aim %>%
  filter(eligibility == 1) %>%
  .[["participant_id"]] %>%
  unique(.) %>%
  length(.)

n_participants_excluded_among_elig <- n_participants_elig - n_participants_included_among_elig

dat_summary <- data.frame(n_participants_elig = n_participants_elig,
                          n_participants_included_among_elig = n_participants_included_among_elig,
                          n_participants_excluded_among_elig = n_participants_excluded_among_elig,
                          n_elig = sum(dat_summary_observed[["total"]]),
                          n_included_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == TRUE, ][["total"]],
                          n_excluded_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == FALSE, ][["total"]])

dat_summary
```

```{r}
dat_for_analysis <- dat_primary_aim %>%
  select(participant_id, decision_point, eligibility, 
         coinflip, Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val,
         all_of(use_these_moderators))
```

```{r}
dat_for_analysis_elig <- dat_for_analysis %>% filter(eligibility == 1)
dat_for_analysis_not_elig <- dat_for_analysis %>% filter(eligibility == 0)
```

```{r}
logical_vec_cc <- dat_for_analysis_elig %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)
```

```{r}
# Note that this line is needed because we are doing a complete case analysis
# We would not need this line if we were doing a multiply imputed analysis
dat_for_analysis_elig <- dat_for_analysis_elig %>% mutate(eligibility = if_else(logical_vec_cc, eligibility, 0))
```

```{r}
dat_for_analysis <- rbind(dat_for_analysis_elig, dat_for_analysis_not_elig)
dat_for_analysis <- dat_for_analysis %>% arrange(participant_id, decision_point)
dat_for_analysis <- dat_for_analysis %>% replace_na(my_list)
```

```{r}
participants_fully_dropped <- dat_for_analysis %>% 
  group_by(participant_id) %>% 
  summarise(count_elig = sum(eligibility)) %>%
  arrange(count_elig) %>%
  filter(count_elig == 0) %>%
  .[["participant_id"]]

if(length(participants_fully_dropped) > 0){
  dat_for_analysis <- dat_for_analysis %>% filter(!(participant_id %in% participants_fully_dropped))
}
```

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ mdes_pos_mean,  
  control_formula = ~ mdes_pos_mean + age + is_male + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_response_2qs + engagement_most_recent_eligible, 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)
```

```{r}
fit <- fit1

dat_result_causal <- summary(fit, show_control_fit = TRUE)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE)[["control_variables"]]
dat_result <- rbind(dat_result_causal, dat_result_control)

dat_result_causal <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["control_variables"]]
dat_result2 <- rbind(dat_result_causal, dat_result_control)
dat_result2 <- dat_result2[, c("90% LCL", "90% UCL")]

dat_result <- cbind(dat_result, dat_result2)
dat_result <- dat_result[, c("Estimate","StdErr","95% LCL","95% UCL","90% LCL","90% UCL","t_value","df","p-value")]

# Format output to 3 decimal places
dat_result %>% round(., 3) %>% format(., nsmall = 3) %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "H3-baseline-moderators", "log_risk_ratio_scale_H3_mdes_pos_mean.csv"), row.names = TRUE)
```

## Mental Health -- mDES negative emotions

```{r}
use_these_moderators <- c("mdes_neg_mean")
```

```{r}
logical_vec_cc <- dat_primary_aim %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)

dat_summary_observed <- dat_primary_aim %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1) %>%
  group_by(is_complete) %>%
  summarise(total = n())

n_participants_included_among_elig <- dat_primary_aim %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1 & is_complete == 1) %>% 
  summarise(total = length(unique(participant_id))) %>%
  .[["total"]]

n_participants_elig <- dat_primary_aim %>%
  filter(eligibility == 1) %>%
  .[["participant_id"]] %>%
  unique(.) %>%
  length(.)

n_participants_excluded_among_elig <- n_participants_elig - n_participants_included_among_elig

dat_summary <- data.frame(n_participants_elig = n_participants_elig,
                          n_participants_included_among_elig = n_participants_included_among_elig,
                          n_participants_excluded_among_elig = n_participants_excluded_among_elig,
                          n_elig = sum(dat_summary_observed[["total"]]),
                          n_included_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == TRUE, ][["total"]],
                          n_excluded_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == FALSE, ][["total"]])

dat_summary
```

```{r}
dat_for_analysis <- dat_primary_aim %>%
  select(participant_id, decision_point, eligibility, 
         coinflip, Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val,
         all_of(use_these_moderators))
```

```{r}
dat_for_analysis_elig <- dat_for_analysis %>% filter(eligibility == 1)
dat_for_analysis_not_elig <- dat_for_analysis %>% filter(eligibility == 0)
```

```{r}
logical_vec_cc <- dat_for_analysis_elig %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)
```

```{r}
# Note that this line is needed because we are doing a complete case analysis
# We would not need this line if we were doing a multiply imputed analysis
dat_for_analysis_elig <- dat_for_analysis_elig %>% mutate(eligibility = if_else(logical_vec_cc, eligibility, 0))
```

```{r}
dat_for_analysis <- rbind(dat_for_analysis_elig, dat_for_analysis_not_elig)
dat_for_analysis <- dat_for_analysis %>% arrange(participant_id, decision_point)
dat_for_analysis <- dat_for_analysis %>% replace_na(my_list)
```

```{r}
participants_fully_dropped <- dat_for_analysis %>% 
  group_by(participant_id) %>% 
  summarise(count_elig = sum(eligibility)) %>%
  arrange(count_elig) %>%
  filter(count_elig == 0) %>%
  .[["participant_id"]]

if(length(participants_fully_dropped) > 0){
  dat_for_analysis <- dat_for_analysis %>% filter(!(participant_id %in% participants_fully_dropped))
}
```

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ mdes_neg_mean,  
  control_formula = ~ mdes_neg_mean + age + is_male + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_response_2qs + engagement_most_recent_eligible, 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)
```

```{r}
fit <- fit1

dat_result_causal <- summary(fit, show_control_fit = TRUE)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE)[["control_variables"]]
dat_result <- rbind(dat_result_causal, dat_result_control)

dat_result_causal <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["control_variables"]]
dat_result2 <- rbind(dat_result_causal, dat_result_control)
dat_result2 <- dat_result2[, c("90% LCL", "90% UCL")]

dat_result <- cbind(dat_result, dat_result2)
dat_result <- dat_result[, c("Estimate","StdErr","95% LCL","95% UCL","90% LCL","90% UCL","t_value","df","p-value")]

# Format output to 3 decimal places
dat_result %>% round(., 3) %>% format(., nsmall = 3) %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "H3-baseline-moderators", "log_risk_ratio_scale_H3_mdes_neg_mean.csv"), row.names = TRUE)
```

## Loneliness

```{r}
use_these_moderators <- c("uclals_mean")
```

```{r}
logical_vec_cc <- dat_primary_aim %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)

dat_summary_observed <- dat_primary_aim %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1) %>%
  group_by(is_complete) %>%
  summarise(total = n())

n_participants_included_among_elig <- dat_primary_aim %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1 & is_complete == 1) %>% 
  summarise(total = length(unique(participant_id))) %>%
  .[["total"]]

n_participants_elig <- dat_primary_aim %>%
  filter(eligibility == 1) %>%
  .[["participant_id"]] %>%
  unique(.) %>%
  length(.)

n_participants_excluded_among_elig <- n_participants_elig - n_participants_included_among_elig

dat_summary <- data.frame(n_participants_elig = n_participants_elig,
                          n_participants_included_among_elig = n_participants_included_among_elig,
                          n_participants_excluded_among_elig = n_participants_excluded_among_elig,
                          n_elig = sum(dat_summary_observed[["total"]]),
                          n_included_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == TRUE, ][["total"]],
                          n_excluded_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == FALSE, ][["total"]])

dat_summary
```

```{r}
dat_for_analysis <- dat_primary_aim %>%
  select(participant_id, decision_point, eligibility, 
         coinflip, Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val,
         all_of(use_these_moderators))
```

```{r}
dat_for_analysis_elig <- dat_for_analysis %>% filter(eligibility == 1)
dat_for_analysis_not_elig <- dat_for_analysis %>% filter(eligibility == 0)
```

```{r}
logical_vec_cc <- dat_for_analysis_elig %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)
```

```{r}
# Note that this line is needed because we are doing a complete case analysis
# We would not need this line if we were doing a multiply imputed analysis
dat_for_analysis_elig <- dat_for_analysis_elig %>% mutate(eligibility = if_else(logical_vec_cc, eligibility, 0))
```

```{r}
dat_for_analysis <- rbind(dat_for_analysis_elig, dat_for_analysis_not_elig)
dat_for_analysis <- dat_for_analysis %>% arrange(participant_id, decision_point)
dat_for_analysis <- dat_for_analysis %>% replace_na(my_list)
```

```{r}
participants_fully_dropped <- dat_for_analysis %>% 
  group_by(participant_id) %>% 
  summarise(count_elig = sum(eligibility)) %>%
  arrange(count_elig) %>%
  filter(count_elig == 0) %>%
  .[["participant_id"]]

if(length(participants_fully_dropped) > 0){
  dat_for_analysis <- dat_for_analysis %>% filter(!(participant_id %in% participants_fully_dropped))
}
```

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ uclals_mean,  
  control_formula = ~ uclals_mean + age + is_male + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_response_2qs + engagement_most_recent_eligible, 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)
```

```{r}
fit <- fit1

dat_result_causal <- summary(fit, show_control_fit = TRUE)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE)[["control_variables"]]
dat_result <- rbind(dat_result_causal, dat_result_control)

dat_result_causal <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["control_variables"]]
dat_result2 <- rbind(dat_result_causal, dat_result_control)
dat_result2 <- dat_result2[, c("90% LCL", "90% UCL")]

dat_result <- cbind(dat_result, dat_result2)
dat_result <- dat_result[, c("Estimate","StdErr","95% LCL","95% UCL","90% LCL","90% UCL","t_value","df","p-value")]

# Format output to 3 decimal places
dat_result %>% round(., 3) %>% format(., nsmall = 3) %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "H3-baseline-moderators", "log_risk_ratio_scale_H3_uclals_mean.csv"), row.names = TRUE)
```

## Substance use -- heaviness of smoking

```{r}
use_these_moderators <- c("Nicotine_dep")
```

```{r}
logical_vec_cc <- dat_primary_aim %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)

dat_summary_observed <- dat_primary_aim %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1) %>%
  group_by(is_complete) %>%
  summarise(total = n())

n_participants_included_among_elig <- dat_primary_aim %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1 & is_complete == 1) %>% 
  summarise(total = length(unique(participant_id))) %>%
  .[["total"]]

n_participants_elig <- dat_primary_aim %>%
  filter(eligibility == 1) %>%
  .[["participant_id"]] %>%
  unique(.) %>%
  length(.)

n_participants_excluded_among_elig <- n_participants_elig - n_participants_included_among_elig

dat_summary <- data.frame(n_participants_elig = n_participants_elig,
                          n_participants_included_among_elig = n_participants_included_among_elig,
                          n_participants_excluded_among_elig = n_participants_excluded_among_elig,
                          n_elig = sum(dat_summary_observed[["total"]]),
                          n_included_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == TRUE, ][["total"]],
                          n_excluded_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == FALSE, ][["total"]])

dat_summary
```

```{r}
dat_for_analysis <- dat_primary_aim %>%
  select(participant_id, decision_point, eligibility, 
         coinflip, Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val,
         all_of(use_these_moderators))
```

```{r}
dat_for_analysis_elig <- dat_for_analysis %>% filter(eligibility == 1)
dat_for_analysis_not_elig <- dat_for_analysis %>% filter(eligibility == 0)
```

```{r}
logical_vec_cc <- dat_for_analysis_elig %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)
```

```{r}
# Note that this line is needed because we are doing a complete case analysis
# We would not need this line if we were doing a multiply imputed analysis
dat_for_analysis_elig <- dat_for_analysis_elig %>% mutate(eligibility = if_else(logical_vec_cc, eligibility, 0))
```

```{r}
dat_for_analysis <- rbind(dat_for_analysis_elig, dat_for_analysis_not_elig)
dat_for_analysis <- dat_for_analysis %>% arrange(participant_id, decision_point)
dat_for_analysis <- dat_for_analysis %>% replace_na(my_list)
```

```{r}
participants_fully_dropped <- dat_for_analysis %>% 
  group_by(participant_id) %>% 
  summarise(count_elig = sum(eligibility)) %>%
  arrange(count_elig) %>%
  filter(count_elig == 0) %>%
  .[["participant_id"]]

if(length(participants_fully_dropped) > 0){
  dat_for_analysis <- dat_for_analysis %>% filter(!(participant_id %in% participants_fully_dropped))
}
```

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ Nicotine_dep,  
  control_formula = ~ Nicotine_dep + age + is_male + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_response_2qs + engagement_most_recent_eligible, 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)
```

```{r}
fit <- fit1

dat_result_causal <- summary(fit, show_control_fit = TRUE)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE)[["control_variables"]]
dat_result <- rbind(dat_result_causal, dat_result_control)

dat_result_causal <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["control_variables"]]
dat_result2 <- rbind(dat_result_causal, dat_result_control)
dat_result2 <- dat_result2[, c("90% LCL", "90% UCL")]

dat_result <- cbind(dat_result, dat_result2)
dat_result <- dat_result[, c("Estimate","StdErr","95% LCL","95% UCL","90% LCL","90% UCL","t_value","df","p-value")]

# Format output to 3 decimal places
dat_result %>% round(., 3) %>% format(., nsmall = 3) %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "H3-baseline-moderators", "log_risk_ratio_scale_H3_Nicotine_dep.csv"), row.names = TRUE)
```

## Substance use -- PHQ alcohol

```{r}
use_these_moderators <- c("phqa_problem")
```

```{r}
logical_vec_cc <- dat_primary_aim %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)

dat_summary_observed <- dat_primary_aim %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1) %>%
  group_by(is_complete) %>%
  summarise(total = n())

n_participants_included_among_elig <- dat_primary_aim %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1 & is_complete == 1) %>% 
  summarise(total = length(unique(participant_id))) %>%
  .[["total"]]

n_participants_elig <- dat_primary_aim %>%
  filter(eligibility == 1) %>%
  .[["participant_id"]] %>%
  unique(.) %>%
  length(.)

n_participants_excluded_among_elig <- n_participants_elig - n_participants_included_among_elig

dat_summary <- data.frame(n_participants_elig = n_participants_elig,
                          n_participants_included_among_elig = n_participants_included_among_elig,
                          n_participants_excluded_among_elig = n_participants_excluded_among_elig,
                          n_elig = sum(dat_summary_observed[["total"]]),
                          n_included_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == TRUE, ][["total"]],
                          n_excluded_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == FALSE, ][["total"]])

dat_summary
```

```{r}
dat_for_analysis <- dat_primary_aim %>%
  select(participant_id, decision_point, eligibility, 
         coinflip, Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val,
         all_of(use_these_moderators))
```

```{r}
dat_for_analysis_elig <- dat_for_analysis %>% filter(eligibility == 1)
dat_for_analysis_not_elig <- dat_for_analysis %>% filter(eligibility == 0)
```

```{r}
logical_vec_cc <- dat_for_analysis_elig %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)
```

```{r}
# Note that this line is needed because we are doing a complete case analysis
# We would not need this line if we were doing a multiply imputed analysis
dat_for_analysis_elig <- dat_for_analysis_elig %>% mutate(eligibility = if_else(logical_vec_cc, eligibility, 0))
```

```{r}
dat_for_analysis <- rbind(dat_for_analysis_elig, dat_for_analysis_not_elig)
dat_for_analysis <- dat_for_analysis %>% arrange(participant_id, decision_point)
dat_for_analysis <- dat_for_analysis %>% replace_na(my_list)
```

```{r}
participants_fully_dropped <- dat_for_analysis %>% 
  group_by(participant_id) %>% 
  summarise(count_elig = sum(eligibility)) %>%
  arrange(count_elig) %>%
  filter(count_elig == 0) %>%
  .[["participant_id"]]

if(length(participants_fully_dropped) > 0){
  dat_for_analysis <- dat_for_analysis %>% filter(!(participant_id %in% participants_fully_dropped))
}
```

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ phqa_problem,  
  control_formula = ~ phqa_problem + age + is_male + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_response_2qs + engagement_most_recent_eligible, 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)
```

```{r}
fit <- fit1

dat_result_causal <- summary(fit, show_control_fit = TRUE)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE)[["control_variables"]]
dat_result <- rbind(dat_result_causal, dat_result_control)

dat_result_causal <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["control_variables"]]
dat_result2 <- rbind(dat_result_causal, dat_result_control)
dat_result2 <- dat_result2[, c("90% LCL", "90% UCL")]

dat_result <- cbind(dat_result, dat_result2)
dat_result <- dat_result[, c("Estimate","StdErr","95% LCL","95% UCL","90% LCL","90% UCL","t_value","df","p-value")]

# Format output to 3 decimal places
dat_result %>% round(., 3) %>% format(., nsmall = 3) %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "H3-baseline-moderators", "log_risk_ratio_scale_H3_phqa_problem.csv"), row.names = TRUE)
```

## Substance use -- ecigarettes and vaping

### Do you use any electronic nicotine delivery system like vape pen, JUUL, or ecigarettes

```{r}
use_these_moderators <- c("ecig_1")
```

```{r}
logical_vec_cc <- dat_primary_aim %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)

dat_summary_observed <- dat_primary_aim %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1) %>%
  group_by(is_complete) %>%
  summarise(total = n())

n_participants_included_among_elig <- dat_primary_aim %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1 & is_complete == 1) %>% 
  summarise(total = length(unique(participant_id))) %>%
  .[["total"]]

n_participants_elig <- dat_primary_aim %>%
  filter(eligibility == 1) %>%
  .[["participant_id"]] %>%
  unique(.) %>%
  length(.)

n_participants_excluded_among_elig <- n_participants_elig - n_participants_included_among_elig

dat_summary <- data.frame(n_participants_elig = n_participants_elig,
                          n_participants_included_among_elig = n_participants_included_among_elig,
                          n_participants_excluded_among_elig = n_participants_excluded_among_elig,
                          n_elig = sum(dat_summary_observed[["total"]]),
                          n_included_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == TRUE, ][["total"]],
                          n_excluded_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == FALSE, ][["total"]])

dat_summary
```

```{r}
dat_for_analysis <- dat_primary_aim %>%
  select(participant_id, decision_point, eligibility, 
         coinflip, Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val,
         all_of(use_these_moderators))
```

```{r}
dat_for_analysis_elig <- dat_for_analysis %>% filter(eligibility == 1)
dat_for_analysis_not_elig <- dat_for_analysis %>% filter(eligibility == 0)
```

```{r}
logical_vec_cc <- dat_for_analysis_elig %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)
```

```{r}
# Note that this line is needed because we are doing a complete case analysis
# We would not need this line if we were doing a multiply imputed analysis
dat_for_analysis_elig <- dat_for_analysis_elig %>% mutate(eligibility = if_else(logical_vec_cc, eligibility, 0))
```

```{r}
dat_for_analysis <- rbind(dat_for_analysis_elig, dat_for_analysis_not_elig)
dat_for_analysis <- dat_for_analysis %>% arrange(participant_id, decision_point)
dat_for_analysis <- dat_for_analysis %>% replace_na(my_list)
```

```{r}
participants_fully_dropped <- dat_for_analysis %>% 
  group_by(participant_id) %>% 
  summarise(count_elig = sum(eligibility)) %>%
  arrange(count_elig) %>%
  filter(count_elig == 0) %>%
  .[["participant_id"]]

if(length(participants_fully_dropped) > 0){
  dat_for_analysis <- dat_for_analysis %>% filter(!(participant_id %in% participants_fully_dropped))
}
```

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ ecig_1,  
  control_formula = ~ ecig_1 + age + is_male + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_response_2qs + engagement_most_recent_eligible, 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)
```

```{r}
fit <- fit1

dat_result_causal <- summary(fit, show_control_fit = TRUE)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE)[["control_variables"]]
dat_result <- rbind(dat_result_causal, dat_result_control)

dat_result_causal <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["control_variables"]]
dat_result2 <- rbind(dat_result_causal, dat_result_control)
dat_result2 <- dat_result2[, c("90% LCL", "90% UCL")]

dat_result <- cbind(dat_result, dat_result2)
dat_result <- dat_result[, c("Estimate","StdErr","95% LCL","95% UCL","90% LCL","90% UCL","t_value","df","p-value")]

# Format output to 3 decimal places
dat_result %>% round(., 3) %>% format(., nsmall = 3) %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "H3-baseline-moderators", "log_risk_ratio_scale_H3_ecig_1.csv"), row.names = TRUE)
```

### During the past 30 days, how many days did you use a vape pen, JUUL, or ecigarette, even one or two puffs?

```{r}
use_these_moderators <- c("ecig_2")
```

```{r}
logical_vec_cc <- dat_primary_aim %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)

dat_summary_observed <- dat_primary_aim %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1) %>%
  group_by(is_complete) %>%
  summarise(total = n())

n_participants_included_among_elig <- dat_primary_aim %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1 & is_complete == 1) %>% 
  summarise(total = length(unique(participant_id))) %>%
  .[["total"]]

n_participants_elig <- dat_primary_aim %>%
  filter(eligibility == 1) %>%
  .[["participant_id"]] %>%
  unique(.) %>%
  length(.)

n_participants_excluded_among_elig <- n_participants_elig - n_participants_included_among_elig

dat_summary <- data.frame(n_participants_elig = n_participants_elig,
                          n_participants_included_among_elig = n_participants_included_among_elig,
                          n_participants_excluded_among_elig = n_participants_excluded_among_elig,
                          n_elig = sum(dat_summary_observed[["total"]]),
                          n_included_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == TRUE, ][["total"]],
                          n_excluded_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == FALSE, ][["total"]])

dat_summary
```

```{r}
dat_for_analysis <- dat_primary_aim %>%
  select(participant_id, decision_point, eligibility, 
         coinflip, Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val,
         all_of(use_these_moderators))
```

```{r}
dat_for_analysis_elig <- dat_for_analysis %>% filter(eligibility == 1)
dat_for_analysis_not_elig <- dat_for_analysis %>% filter(eligibility == 0)
```

```{r}
logical_vec_cc <- dat_for_analysis_elig %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)
```

```{r}
# Note that this line is needed because we are doing a complete case analysis
# We would not need this line if we were doing a multiply imputed analysis
dat_for_analysis_elig <- dat_for_analysis_elig %>% mutate(eligibility = if_else(logical_vec_cc, eligibility, 0))
```

```{r}
dat_for_analysis <- rbind(dat_for_analysis_elig, dat_for_analysis_not_elig)
dat_for_analysis <- dat_for_analysis %>% arrange(participant_id, decision_point)
dat_for_analysis <- dat_for_analysis %>% replace_na(my_list)
```

```{r}
participants_fully_dropped <- dat_for_analysis %>% 
  group_by(participant_id) %>% 
  summarise(count_elig = sum(eligibility)) %>%
  arrange(count_elig) %>%
  filter(count_elig == 0) %>%
  .[["participant_id"]]

if(length(participants_fully_dropped) > 0){
  dat_for_analysis <- dat_for_analysis %>% filter(!(participant_id %in% participants_fully_dropped))
}
```

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ ecig_2,  
  control_formula = ~ ecig_2 + age + is_male + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_response_2qs + engagement_most_recent_eligible, 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)
```

```{r}
fit <- fit1

dat_result_causal <- summary(fit, show_control_fit = TRUE)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE)[["control_variables"]]
dat_result <- rbind(dat_result_causal, dat_result_control)

dat_result_causal <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["control_variables"]]
dat_result2 <- rbind(dat_result_causal, dat_result_control)
dat_result2 <- dat_result2[, c("90% LCL", "90% UCL")]

dat_result <- cbind(dat_result, dat_result2)
dat_result <- dat_result[, c("Estimate","StdErr","95% LCL","95% UCL","90% LCL","90% UCL","t_value","df","p-value")]

# Format output to 3 decimal places
dat_result %>% round(., 3) %>% format(., nsmall = 3) %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "H3-baseline-moderators", "log_risk_ratio_scale_H3_ecig_2.csv"), row.names = TRUE)
```

### On days you use a vape pen or JUUL, please estimate how many separate times per day you usually use it.

```{r}
use_these_moderators <- c("ecig_3")
```

```{r}
logical_vec_cc <- dat_primary_aim %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)

dat_summary_observed <- dat_primary_aim %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1) %>%
  group_by(is_complete) %>%
  summarise(total = n())

n_participants_included_among_elig <- dat_primary_aim %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1 & is_complete == 1) %>% 
  summarise(total = length(unique(participant_id))) %>%
  .[["total"]]

n_participants_elig <- dat_primary_aim %>%
  filter(eligibility == 1) %>%
  .[["participant_id"]] %>%
  unique(.) %>%
  length(.)

n_participants_excluded_among_elig <- n_participants_elig - n_participants_included_among_elig

dat_summary <- data.frame(n_participants_elig = n_participants_elig,
                          n_participants_included_among_elig = n_participants_included_among_elig,
                          n_participants_excluded_among_elig = n_participants_excluded_among_elig,
                          n_elig = sum(dat_summary_observed[["total"]]),
                          n_included_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == TRUE, ][["total"]],
                          n_excluded_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == FALSE, ][["total"]])

dat_summary
```

```{r}
dat_for_analysis <- dat_primary_aim %>%
  select(participant_id, decision_point, eligibility, 
         coinflip, Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val,
         all_of(use_these_moderators))
```

```{r}
dat_for_analysis_elig <- dat_for_analysis %>% filter(eligibility == 1)
dat_for_analysis_not_elig <- dat_for_analysis %>% filter(eligibility == 0)
```

```{r}
logical_vec_cc <- dat_for_analysis_elig %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)
```

```{r}
# Note that this line is needed because we are doing a complete case analysis
# We would not need this line if we were doing a multiply imputed analysis
dat_for_analysis_elig <- dat_for_analysis_elig %>% mutate(eligibility = if_else(logical_vec_cc, eligibility, 0))
```

```{r}
dat_for_analysis <- rbind(dat_for_analysis_elig, dat_for_analysis_not_elig)
dat_for_analysis <- dat_for_analysis %>% arrange(participant_id, decision_point)
dat_for_analysis <- dat_for_analysis %>% replace_na(my_list)
```

```{r}
participants_fully_dropped <- dat_for_analysis %>% 
  group_by(participant_id) %>% 
  summarise(count_elig = sum(eligibility)) %>%
  arrange(count_elig) %>%
  filter(count_elig == 0) %>%
  .[["participant_id"]]

if(length(participants_fully_dropped) > 0){
  dat_for_analysis <- dat_for_analysis %>% filter(!(participant_id %in% participants_fully_dropped))
}
```

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ ecig_3,  
  control_formula = ~ ecig_3 + age + is_male + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_response_2qs + engagement_most_recent_eligible, 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)
```

```{r}
fit <- fit1

dat_result_causal <- summary(fit, show_control_fit = TRUE)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE)[["control_variables"]]
dat_result <- rbind(dat_result_causal, dat_result_control)

dat_result_causal <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["control_variables"]]
dat_result2 <- rbind(dat_result_causal, dat_result_control)
dat_result2 <- dat_result2[, c("90% LCL", "90% UCL")]

dat_result <- cbind(dat_result, dat_result2)
dat_result <- dat_result[, c("Estimate","StdErr","95% LCL","95% UCL","90% LCL","90% UCL","t_value","df","p-value")]

# Format output to 3 decimal places
dat_result %>% round(., 3) %>% format(., nsmall = 3) %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "H3-baseline-moderators", "log_risk_ratio_scale_H3_ecig_3.csv"), row.names = TRUE)
```

### How many vape pen, JUUL, or ecigarette puffs on average do you take each time you use it?

```{r}
use_these_moderators <- c("ecig_4")
```

```{r}
logical_vec_cc <- dat_primary_aim %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)

dat_summary_observed <- dat_primary_aim %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1) %>%
  group_by(is_complete) %>%
  summarise(total = n())

n_participants_included_among_elig <- dat_primary_aim %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1 & is_complete == 1) %>% 
  summarise(total = length(unique(participant_id))) %>%
  .[["total"]]

n_participants_elig <- dat_primary_aim %>%
  filter(eligibility == 1) %>%
  .[["participant_id"]] %>%
  unique(.) %>%
  length(.)

n_participants_excluded_among_elig <- n_participants_elig - n_participants_included_among_elig

dat_summary <- data.frame(n_participants_elig = n_participants_elig,
                          n_participants_included_among_elig = n_participants_included_among_elig,
                          n_participants_excluded_among_elig = n_participants_excluded_among_elig,
                          n_elig = sum(dat_summary_observed[["total"]]),
                          n_included_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == TRUE, ][["total"]],
                          n_excluded_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == FALSE, ][["total"]])

dat_summary
```

```{r}
dat_for_analysis <- dat_primary_aim %>%
  select(participant_id, decision_point, eligibility, 
         coinflip, Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val,
         all_of(use_these_moderators))
```

```{r}
dat_for_analysis_elig <- dat_for_analysis %>% filter(eligibility == 1)
dat_for_analysis_not_elig <- dat_for_analysis %>% filter(eligibility == 0)
```

```{r}
logical_vec_cc <- dat_for_analysis_elig %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)
```

```{r}
# Note that this line is needed because we are doing a complete case analysis
# We would not need this line if we were doing a multiply imputed analysis
dat_for_analysis_elig <- dat_for_analysis_elig %>% mutate(eligibility = if_else(logical_vec_cc, eligibility, 0))
```

```{r}
dat_for_analysis <- rbind(dat_for_analysis_elig, dat_for_analysis_not_elig)
dat_for_analysis <- dat_for_analysis %>% arrange(participant_id, decision_point)
dat_for_analysis <- dat_for_analysis %>% replace_na(my_list)
```

```{r}
participants_fully_dropped <- dat_for_analysis %>% 
  group_by(participant_id) %>% 
  summarise(count_elig = sum(eligibility)) %>%
  arrange(count_elig) %>%
  filter(count_elig == 0) %>%
  .[["participant_id"]]

if(length(participants_fully_dropped) > 0){
  dat_for_analysis <- dat_for_analysis %>% filter(!(participant_id %in% participants_fully_dropped))
}
```

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ ecig_4,  
  control_formula = ~ ecig_4 + age + is_male + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_response_2qs + engagement_most_recent_eligible, 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)
```

```{r}
fit <- fit1

dat_result_causal <- summary(fit, show_control_fit = TRUE)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE)[["control_variables"]]
dat_result <- rbind(dat_result_causal, dat_result_control)

dat_result_causal <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["control_variables"]]
dat_result2 <- rbind(dat_result_causal, dat_result_control)
dat_result2 <- dat_result2[, c("90% LCL", "90% UCL")]

dat_result <- cbind(dat_result, dat_result2)
dat_result <- dat_result[, c("Estimate","StdErr","95% LCL","95% UCL","90% LCL","90% UCL","t_value","df","p-value")]

# Format output to 3 decimal places
dat_result %>% round(., 3) %>% format(., nsmall = 3) %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "H3-baseline-moderators", "log_risk_ratio_scale_H3_ecig_4.csv"), row.names = TRUE)
```

## Mindfulness -- MAAS5

```{r}
use_these_moderators <- c("maas_total")
```

```{r}
logical_vec_cc <- dat_primary_aim %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)

dat_summary_observed <- dat_primary_aim %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1) %>%
  group_by(is_complete) %>%
  summarise(total = n())

n_participants_included_among_elig <- dat_primary_aim %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1 & is_complete == 1) %>% 
  summarise(total = length(unique(participant_id))) %>%
  .[["total"]]

n_participants_elig <- dat_primary_aim %>%
  filter(eligibility == 1) %>%
  .[["participant_id"]] %>%
  unique(.) %>%
  length(.)

n_participants_excluded_among_elig <- n_participants_elig - n_participants_included_among_elig

dat_summary <- data.frame(n_participants_elig = n_participants_elig,
                          n_participants_included_among_elig = n_participants_included_among_elig,
                          n_participants_excluded_among_elig = n_participants_excluded_among_elig,
                          n_elig = sum(dat_summary_observed[["total"]]),
                          n_included_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == TRUE, ][["total"]],
                          n_excluded_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == FALSE, ][["total"]])

dat_summary
```

```{r}
dat_for_analysis <- dat_primary_aim %>%
  select(participant_id, decision_point, eligibility, 
         coinflip, Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val,
         all_of(use_these_moderators))
```

```{r}
dat_for_analysis_elig <- dat_for_analysis %>% filter(eligibility == 1)
dat_for_analysis_not_elig <- dat_for_analysis %>% filter(eligibility == 0)
```

```{r}
logical_vec_cc <- dat_for_analysis_elig %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)
```

```{r}
# Note that this line is needed because we are doing a complete case analysis
# We would not need this line if we were doing a multiply imputed analysis
dat_for_analysis_elig <- dat_for_analysis_elig %>% mutate(eligibility = if_else(logical_vec_cc, eligibility, 0))
```

```{r}
dat_for_analysis <- rbind(dat_for_analysis_elig, dat_for_analysis_not_elig)
dat_for_analysis <- dat_for_analysis %>% arrange(participant_id, decision_point)
dat_for_analysis <- dat_for_analysis %>% replace_na(my_list)
```

```{r}
participants_fully_dropped <- dat_for_analysis %>% 
  group_by(participant_id) %>% 
  summarise(count_elig = sum(eligibility)) %>%
  arrange(count_elig) %>%
  filter(count_elig == 0) %>%
  .[["participant_id"]]

if(length(participants_fully_dropped) > 0){
  dat_for_analysis <- dat_for_analysis %>% filter(!(participant_id %in% participants_fully_dropped))
}
```

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ maas_total,  
  control_formula = ~ maas_total + age + is_male + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_response_2qs + engagement_most_recent_eligible, 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)
```

```{r}
fit <- fit1

dat_result_causal <- summary(fit, show_control_fit = TRUE)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE)[["control_variables"]]
dat_result <- rbind(dat_result_causal, dat_result_control)

dat_result_causal <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["control_variables"]]
dat_result2 <- rbind(dat_result_causal, dat_result_control)
dat_result2 <- dat_result2[, c("90% LCL", "90% UCL")]

dat_result <- cbind(dat_result, dat_result2)
dat_result <- dat_result[, c("Estimate","StdErr","95% LCL","95% UCL","90% LCL","90% UCL","t_value","df","p-value")]

# Format output to 3 decimal places
dat_result %>% round(., 3) %>% format(., nsmall = 3) %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "H3-baseline-moderators", "log_risk_ratio_scale_H3_maas_total.csv"), row.names = TRUE)
```

## Mindfulness -- five facet

### Mindfulness: higher scores indicate higher overall mindfulness

```{r}
use_these_moderators <- c("FFMQ_total")
```

```{r}
logical_vec_cc <- dat_primary_aim %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)

dat_summary_observed <- dat_primary_aim %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1) %>%
  group_by(is_complete) %>%
  summarise(total = n())

n_participants_included_among_elig <- dat_primary_aim %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1 & is_complete == 1) %>% 
  summarise(total = length(unique(participant_id))) %>%
  .[["total"]]

n_participants_elig <- dat_primary_aim %>%
  filter(eligibility == 1) %>%
  .[["participant_id"]] %>%
  unique(.) %>%
  length(.)

n_participants_excluded_among_elig <- n_participants_elig - n_participants_included_among_elig

dat_summary <- data.frame(n_participants_elig = n_participants_elig,
                          n_participants_included_among_elig = n_participants_included_among_elig,
                          n_participants_excluded_among_elig = n_participants_excluded_among_elig,
                          n_elig = sum(dat_summary_observed[["total"]]),
                          n_included_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == TRUE, ][["total"]],
                          n_excluded_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == FALSE, ][["total"]])

dat_summary
```

```{r}
dat_for_analysis <- dat_primary_aim %>%
  select(participant_id, decision_point, eligibility, 
         coinflip, Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val,
         all_of(use_these_moderators))
```

```{r}
dat_for_analysis_elig <- dat_for_analysis %>% filter(eligibility == 1)
dat_for_analysis_not_elig <- dat_for_analysis %>% filter(eligibility == 0)
```

```{r}
logical_vec_cc <- dat_for_analysis_elig %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)
```

```{r}
# Note that this line is needed because we are doing a complete case analysis
# We would not need this line if we were doing a multiply imputed analysis
dat_for_analysis_elig <- dat_for_analysis_elig %>% mutate(eligibility = if_else(logical_vec_cc, eligibility, 0))
```

```{r}
dat_for_analysis <- rbind(dat_for_analysis_elig, dat_for_analysis_not_elig)
dat_for_analysis <- dat_for_analysis %>% arrange(participant_id, decision_point)
dat_for_analysis <- dat_for_analysis %>% replace_na(my_list)
```

```{r}
participants_fully_dropped <- dat_for_analysis %>% 
  group_by(participant_id) %>% 
  summarise(count_elig = sum(eligibility)) %>%
  arrange(count_elig) %>%
  filter(count_elig == 0) %>%
  .[["participant_id"]]

if(length(participants_fully_dropped) > 0){
  dat_for_analysis <- dat_for_analysis %>% filter(!(participant_id %in% participants_fully_dropped))
}
```

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ FFMQ_total,  
  control_formula = ~ FFMQ_total + age + is_male + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_response_2qs + engagement_most_recent_eligible, 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)
```

```{r}
fit <- fit1

dat_result_causal <- summary(fit, show_control_fit = TRUE)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE)[["control_variables"]]
dat_result <- rbind(dat_result_causal, dat_result_control)

dat_result_causal <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["control_variables"]]
dat_result2 <- rbind(dat_result_causal, dat_result_control)
dat_result2 <- dat_result2[, c("90% LCL", "90% UCL")]

dat_result <- cbind(dat_result, dat_result2)
dat_result <- dat_result[, c("Estimate","StdErr","95% LCL","95% UCL","90% LCL","90% UCL","t_value","df","p-value")]

# Format output to 3 decimal places
dat_result %>% round(., 3) %>% format(., nsmall = 3) %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "H3-baseline-moderators", "log_risk_ratio_scale_H3_FFMQ_total.csv"), row.names = TRUE)
```

### Mindfulness: higher scores indicate higher non-judging of inner experiences

```{r}
use_these_moderators <- c("ffmq_nonjudge")
```

```{r}
logical_vec_cc <- dat_primary_aim %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)

dat_summary_observed <- dat_primary_aim %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1) %>%
  group_by(is_complete) %>%
  summarise(total = n())

n_participants_included_among_elig <- dat_primary_aim %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1 & is_complete == 1) %>% 
  summarise(total = length(unique(participant_id))) %>%
  .[["total"]]

n_participants_elig <- dat_primary_aim %>%
  filter(eligibility == 1) %>%
  .[["participant_id"]] %>%
  unique(.) %>%
  length(.)

n_participants_excluded_among_elig <- n_participants_elig - n_participants_included_among_elig

dat_summary <- data.frame(n_participants_elig = n_participants_elig,
                          n_participants_included_among_elig = n_participants_included_among_elig,
                          n_participants_excluded_among_elig = n_participants_excluded_among_elig,
                          n_elig = sum(dat_summary_observed[["total"]]),
                          n_included_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == TRUE, ][["total"]],
                          n_excluded_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == FALSE, ][["total"]])

dat_summary
```

```{r}
dat_for_analysis <- dat_primary_aim %>%
  select(participant_id, decision_point, eligibility, 
         coinflip, Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val,
         all_of(use_these_moderators))
```

```{r}
dat_for_analysis_elig <- dat_for_analysis %>% filter(eligibility == 1)
dat_for_analysis_not_elig <- dat_for_analysis %>% filter(eligibility == 0)
```

```{r}
logical_vec_cc <- dat_for_analysis_elig %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)
```

```{r}
# Note that this line is needed because we are doing a complete case analysis
# We would not need this line if we were doing a multiply imputed analysis
dat_for_analysis_elig <- dat_for_analysis_elig %>% mutate(eligibility = if_else(logical_vec_cc, eligibility, 0))
```

```{r}
dat_for_analysis <- rbind(dat_for_analysis_elig, dat_for_analysis_not_elig)
dat_for_analysis <- dat_for_analysis %>% arrange(participant_id, decision_point)
dat_for_analysis <- dat_for_analysis %>% replace_na(my_list)
```

```{r}
participants_fully_dropped <- dat_for_analysis %>% 
  group_by(participant_id) %>% 
  summarise(count_elig = sum(eligibility)) %>%
  arrange(count_elig) %>%
  filter(count_elig == 0) %>%
  .[["participant_id"]]

if(length(participants_fully_dropped) > 0){
  dat_for_analysis <- dat_for_analysis %>% filter(!(participant_id %in% participants_fully_dropped))
}
```

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ ffmq_nonjudge,  
  control_formula = ~ ffmq_nonjudge + age + is_male + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_response_2qs + engagement_most_recent_eligible, 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)
```

```{r}
fit <- fit1

dat_result_causal <- summary(fit, show_control_fit = TRUE)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE)[["control_variables"]]
dat_result <- rbind(dat_result_causal, dat_result_control)

dat_result_causal <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["control_variables"]]
dat_result2 <- rbind(dat_result_causal, dat_result_control)
dat_result2 <- dat_result2[, c("90% LCL", "90% UCL")]

dat_result <- cbind(dat_result, dat_result2)
dat_result <- dat_result[, c("Estimate","StdErr","95% LCL","95% UCL","90% LCL","90% UCL","t_value","df","p-value")]

# Format output to 3 decimal places
dat_result %>% round(., 3) %>% format(., nsmall = 3) %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "H3-baseline-moderators", "log_risk_ratio_scale_H3_ffmq_nonjudge.csv"), row.names = TRUE)
```

### Mindfulness: higher scores indicate greater acting with awareness

```{r}
use_these_moderators <- c("ffmq_aware")
```

```{r}
logical_vec_cc <- dat_primary_aim %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)

dat_summary_observed <- dat_primary_aim %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1) %>%
  group_by(is_complete) %>%
  summarise(total = n())

n_participants_included_among_elig <- dat_primary_aim %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1 & is_complete == 1) %>% 
  summarise(total = length(unique(participant_id))) %>%
  .[["total"]]

n_participants_elig <- dat_primary_aim %>%
  filter(eligibility == 1) %>%
  .[["participant_id"]] %>%
  unique(.) %>%
  length(.)

n_participants_excluded_among_elig <- n_participants_elig - n_participants_included_among_elig

dat_summary <- data.frame(n_participants_elig = n_participants_elig,
                          n_participants_included_among_elig = n_participants_included_among_elig,
                          n_participants_excluded_among_elig = n_participants_excluded_among_elig,
                          n_elig = sum(dat_summary_observed[["total"]]),
                          n_included_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == TRUE, ][["total"]],
                          n_excluded_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == FALSE, ][["total"]])

dat_summary
```

```{r}
dat_for_analysis <- dat_primary_aim %>%
  select(participant_id, decision_point, eligibility, 
         coinflip, Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val,
         all_of(use_these_moderators))
```

```{r}
dat_for_analysis_elig <- dat_for_analysis %>% filter(eligibility == 1)
dat_for_analysis_not_elig <- dat_for_analysis %>% filter(eligibility == 0)
```

```{r}
logical_vec_cc <- dat_for_analysis_elig %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)
```

```{r}
# Note that this line is needed because we are doing a complete case analysis
# We would not need this line if we were doing a multiply imputed analysis
dat_for_analysis_elig <- dat_for_analysis_elig %>% mutate(eligibility = if_else(logical_vec_cc, eligibility, 0))
```

```{r}
dat_for_analysis <- rbind(dat_for_analysis_elig, dat_for_analysis_not_elig)
dat_for_analysis <- dat_for_analysis %>% arrange(participant_id, decision_point)
dat_for_analysis <- dat_for_analysis %>% replace_na(my_list)
```

```{r}
participants_fully_dropped <- dat_for_analysis %>% 
  group_by(participant_id) %>% 
  summarise(count_elig = sum(eligibility)) %>%
  arrange(count_elig) %>%
  filter(count_elig == 0) %>%
  .[["participant_id"]]

if(length(participants_fully_dropped) > 0){
  dat_for_analysis <- dat_for_analysis %>% filter(!(participant_id %in% participants_fully_dropped))
}
```

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ ffmq_aware,  
  control_formula = ~ ffmq_aware + age + is_male + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_response_2qs + engagement_most_recent_eligible, 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)
```

```{r}
fit <- fit1

dat_result_causal <- summary(fit, show_control_fit = TRUE)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE)[["control_variables"]]
dat_result <- rbind(dat_result_causal, dat_result_control)

dat_result_causal <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE, conf_level = 0.90)[["control_variables"]]
dat_result2 <- rbind(dat_result_causal, dat_result_control)
dat_result2 <- dat_result2[, c("90% LCL", "90% UCL")]

dat_result <- cbind(dat_result, dat_result2)
dat_result <- dat_result[, c("Estimate","StdErr","95% LCL","95% UCL","90% LCL","90% UCL","t_value","df","p-value")]

# Format output to 3 decimal places
dat_result %>% round(., 3) %>% format(., nsmall = 3) %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "H3-baseline-moderators", "log_risk_ratio_scale_H3_ffmq_aware.csv"), row.names = TRUE)
```

## Gratitude

```{r}
use_these_moderators <- c("gratitude")
```

```{r}
logical_vec_cc <- dat_primary_aim %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)

dat_summary_observed <- dat_primary_aim %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1) %>%
  group_by(is_complete) %>%
  summarise(total = n())

n_participants_included_among_elig <- dat_primary_aim %>% 
  mutate(is_complete = logical_vec_cc) %>% 
  filter(eligibility == 1 & is_complete == 1) %>% 
  summarise(total = length(unique(participant_id))) %>%
  .[["total"]]

n_participants_elig <- dat_primary_aim %>%
  filter(eligibility == 1) %>%
  .[["participant_id"]] %>%
  unique(.) %>%
  length(.)

n_participants_excluded_among_elig <- n_participants_elig - n_participants_included_among_elig

dat_summary <- data.frame(n_participants_elig = n_participants_elig,
                          n_participants_included_among_elig = n_participants_included_among_elig,
                          n_participants_excluded_among_elig = n_participants_excluded_among_elig,
                          n_elig = sum(dat_summary_observed[["total"]]),
                          n_included_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == TRUE, ][["total"]],
                          n_excluded_among_elig = dat_summary_observed[dat_summary_observed[["is_complete"]] == FALSE, ][["total"]])

dat_summary
```

```{r}
dat_for_analysis <- dat_primary_aim %>%
  select(participant_id, decision_point, eligibility, 
         coinflip, Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val,
         all_of(use_these_moderators))
```

```{r}
dat_for_analysis_elig <- dat_for_analysis %>% filter(eligibility == 1)
dat_for_analysis_not_elig <- dat_for_analysis %>% filter(eligibility == 0)
```

```{r}
logical_vec_cc <- dat_for_analysis_elig %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_male, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val, 
         all_of(use_these_moderators)) %>%
  complete.cases(.)
```

```{r}
# Note that this line is needed because we are doing a complete case analysis
# We would not need this line if we were doing a multiply imputed analysis
dat_for_analysis_elig <- dat_for_analysis_elig %>% mutate(eligibility = if_else(logical_vec_cc, eligibility, 0))
```

```{r}
dat_for_analysis <- rbind(dat_for_analysis_elig, dat_for_analysis_not_elig)
dat_for_analysis <- dat_for_analysis %>% arrange(participant_id, decision_point)
dat_for_analysis <- dat_for_analysis %>% replace_na(my_list)
```

```{r}
participants_fully_dropped <- dat_for_analysis %>% 
  group_by(participant_id) %>% 
  summarise(count_elig = sum(eligibility)) %>%
  arrange(count_elig) %>%
  filter(count_elig == 0) %>%
  .[["participant_id"]]

if(length(participants_fully_dropped) > 0){
  dat_for_analysis <- dat_for_analysis %>% filter(!(participant_id %in% participants_fully_dropped))
}
```

### Estimated effect on the log-risk ratio scale

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ gratitude,  
  control_formula = ~ gratitude + age + is_male + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_response_2qs + engagement_most_recent_eligible, 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)
```

```{r}
fit <- fit1

vals_to_display <- seq(1,7,0.05)

Lmat <- matrix(c(rep(1, length(vals_to_display)),
                 vals_to_display),
               byrow = FALSE,
               ncol = 2)

dat_result_causal <- summary(fit, show_control_fit = TRUE, lincomb = Lmat)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE, lincomb = Lmat)[["control_variables"]]
dat_result <- rbind(dat_result_causal, dat_result_control)

dat_result_causal <- summary(fit, show_control_fit = TRUE, lincomb = Lmat, conf_level = 0.90)[["causal_excursion_effect"]]
dat_result_control <- summary(fit, show_control_fit = TRUE, lincomb = Lmat, conf_level = 0.90)[["control_variables"]]
dat_result2 <- rbind(dat_result_causal, dat_result_control)
dat_result2 <- dat_result2[, c("90% LCL", "90% UCL")]

dat_result <- cbind(dat_result, dat_result2)
dat_result <- dat_result[, c("Estimate","StdErr","95% LCL","95% UCL","90% LCL","90% UCL","t_value","df","p-value")]

# Format output to 3 decimal places
dat_result %>% round(., 3) %>% format(., nsmall = 3) %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "H3-baseline-moderators", "log_risk_ratio_scale_H3_gratitude.csv"), row.names = TRUE)
```

### Estimated effect on the risk ratio scale

```{r}
exp_estimates <- exp(dat_result[,"Estimate"])

rrLB95 <- exp(dat_result[,"95% LCL"])
rrUB95 <- exp(dat_result[,"95% UCL"])

rrLB90 <- exp(dat_result[,"90% LCL"])
rrUB90 <- exp(dat_result[,"90% UCL"])
```

```{r}
dat_result_exp <- data.frame(variable = row.names(dat_result),
                             exp_estimates = exp_estimates,
                             rrLB95 = rrLB95, rrUB95 = rrUB95,
                             rrLB90 = rrLB90, rrUB90 = rrUB90)
```

```{r}
dat_result_exp
```

```{r}
dat_result_exp_output <- dat_result_exp

dat_result_exp_output[,2:ncol(dat_result_exp_output)] <- format(round(dat_result_exp_output[,2:ncol(dat_result_exp_output)], 3), nsmall = 3)

dat_result_exp_output %>% write.csv(., file.path("analysis-complete-case", "formatted-output", "H3-baseline-moderators", "risk_ratio_scale_H3_gratitude.csv"), row.names = TRUE)
```

```{r}
dat_plot <- data.frame(val = vals_to_display, est = exp_estimates[3:123], rrLB95 = rrLB95[3:123], rrUB95 = rrUB95[3:123])

dat_plot

g <- ggplot(data = dat_plot, aes(x = val, y = est, ymin = rrLB95, ymax = rrUB95))
g <- g + geom_abline(slope = 0, intercept = 1, color = "red", linewidth = 1) + geom_ribbon(alpha = 0.3) + geom_line(linewidth = 2) + scale_y_continuous(limits = c(0.5,3.5), breaks = seq(0.5, 3.5, 0.5), name = "Risk Ratio and 95% CI's") + scale_x_continuous(name = "Value of Gratitude", breaks = c(1,2,3,4,5,6,7), labels = c(1,2,3,4,5,6,7))

g

ggsave(filename = file.path("analysis-complete-case", "formatted-output", "H3-baseline-moderators", "risk_ratio_scale_H3_gratitude_CI95.png"), width = 7, height = 5, units = "in")
```


```{r}
dat_plot <- data.frame(val = vals_to_display, est = exp_estimates[3:123], rrLB90 = rrLB90[3:123], rrUB90 = rrUB90[3:123])

dat_plot

g <- ggplot(data = dat_plot, aes(x = val, y = est, ymin = rrLB90, ymax = rrUB90))
g <- g + geom_abline(slope = 0, intercept = 1, color = "red", linewidth = 1) + geom_ribbon(alpha = 0.3) + geom_line(linewidth = 2) + scale_y_continuous(limits = c(0.5,3.5), breaks = seq(0.5, 3.5, 0.5), name = "Risk Ratio and 90% CI's") + scale_x_continuous(name = "Value of Gratitude", breaks = c(1,2,3,4,5,6,7), labels = c(1,2,3,4,5,6,7))

g

ggsave(filename = file.path("analysis-complete-case", "formatted-output", "H3-baseline-moderators", "risk_ratio_scale_H3_gratitude_CI90.png"), width = 7, height = 5, units = "in")
```

```{r}
if(file.exists("analysis-complete-case/formatted-output/H3-baseline-moderators/Thumbs.db")){
  file.remove("analysis-complete-case/formatted-output/H3-baseline-moderators/Thumbs.db")
}
```
