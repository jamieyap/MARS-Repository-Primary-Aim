---
title: "MARS MRT: Additional analyses"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document:
    toc: TRUE
    toc_depth: 4
    number_sections: TRUE
---

```{=html}
<style type="text/css">
.main-container {
  max-width: 1800px !important;
  margin-left: auto;
  margin-right: auto;
}
</style>
```
```{r global_options, include=FALSE}
knitr::opts_chunk$set(tidy = TRUE)
knitr::opts_chunk$set(fig.pos = 'H')
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)
options(width = 7000)
```

```{r}
source("paths.R")
library(knitr)
library(tidyverse)
library(MRTAnalysis)
```

The analyses in this document investigate whether there might be other moderators of the effect of prompt versus no prompt (aside from the ones investigated for Hypothesis 3a and 3b).

```{r}
# This is the data frame that is the output of the very last step of our data pipeline
dat_primary_aim <- readRDS(file = file.path(path_manipulated_data, "dat_primary_aim.rds")) 
dat_primary_aim <- dat_primary_aim %>%
  # Note that in contrast to H1, in H3 there is no sensitivity analysis where we re-do the analyses using all 10 days of the MRT
  mutate(is_include_main = if_else((decision_point >= 7) & (decision_point <= 54), 1, 0))                                                    
```

```{r}
dat_primary_aim <- dat_primary_aim %>% mutate(eligibility_lag1 = lag(eligibility)) 
```

```{r}
dat_for_analysis <- dat_primary_aim %>%
  filter(is_include_main == 1) %>%
  select(participant_id, decision_point, eligibility, 
         coinflip, Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_female, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val,
         eligibility_lag1, coinflip_most_recent_eligible, hours_elapsed_since_most_recent_eligible)
```

```{r}
my_list <- list(Y = -1,
                coinflip = -1,
                hour_coinflip_local = -1, 
                days_between_v1_and_coinflip_local = -1,
                any_response_2qs = -1, 
                any_recent_eligible_dp = -1, 
                engagement_most_recent_eligible = -1,
                age = -1, 
                is_female = -1, 
                is_latino = -1, 
                is_not_latino_and_black = -1, 
                is_not_latino_and_other = -1, 
                baseline_tobacco_history = -1, 
                has_partner = -1, 
                income_val = -1)
```

```{r}
dat_for_analysis_elig <- dat_for_analysis %>% filter(eligibility == 1)
dat_for_analysis_not_elig <- dat_for_analysis %>% filter(eligibility == 0)
```

```{r}
logical_vec_cc <- dat_for_analysis_elig %>% 
  select(Y,
         hour_coinflip_local, days_between_v1_and_coinflip_local,
         any_response_2qs, any_recent_eligible_dp, engagement_most_recent_eligible,
         age, is_female, is_latino, is_not_latino_and_black, is_not_latino_and_other, baseline_tobacco_history, has_partner, income_val) %>%
  complete.cases(.)
```

```{r}
# Note that this line is needed because we are doing a complete case analysis
# We would not need this line if we were doing a multiply imputed analysis
dat_for_analysis_elig <- dat_for_analysis_elig %>% mutate(eligibility = if_else(logical_vec_cc, eligibility, 0))
```

```{r}
dat_for_analysis <- rbind(dat_for_analysis_elig, dat_for_analysis_not_elig)
dat_for_analysis <- dat_for_analysis %>% arrange(participant_id, decision_point)
dat_for_analysis <- dat_for_analysis %>% replace_na(my_list)
```

# Hour of day

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ hour_coinflip_local,  
  control_formula = ~ age + is_female + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_response_2qs + any_recent_eligible_dp + engagement_most_recent_eligible, 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)
```

# Prior eligibility for micro-randomization

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ eligibility_lag1,  
  control_formula = ~ age + is_female + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_response_2qs + any_recent_eligible_dp + engagement_most_recent_eligible + eligibility_lag1, 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)
```

# Whether micro-randomized to prompt at most recent eligible decision point

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ any_recent_eligible_dp + coinflip_most_recent_eligible,  
  control_formula = ~ age + is_female + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_response_2qs + any_recent_eligible_dp + engagement_most_recent_eligible + coinflip_most_recent_eligible, 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)
```

# Whether micro-randomized to prompt at most recent eligible decision point and hours elapsed since most recent eligible decision point

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ any_recent_eligible_dp + coinflip_most_recent_eligible + hours_elapsed_since_most_recent_eligible + I(coinflip_most_recent_eligible * hours_elapsed_since_most_recent_eligible),  
  control_formula = ~ age + is_female + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_response_2qs + any_recent_eligible_dp + engagement_most_recent_eligible + coinflip_most_recent_eligible + hours_elapsed_since_most_recent_eligible + I(coinflip_most_recent_eligible * hours_elapsed_since_most_recent_eligible), 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)
```

# Age

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ age,  
  control_formula = ~ age + is_female + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_response_2qs + any_recent_eligible_dp + engagement_most_recent_eligible, 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)
```

# Gender

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ is_female,  
  control_formula = ~ age + is_female + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_response_2qs + any_recent_eligible_dp + engagement_most_recent_eligible, 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)
```

# Race/ethnicity

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ is_latino + is_not_latino_and_black + is_not_latino_and_other,  
  control_formula = ~ age + is_female + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_response_2qs + any_recent_eligible_dp + engagement_most_recent_eligible, 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)
```

# Baseline tobacco history

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ baseline_tobacco_history,  
  control_formula = ~ age + is_female + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_response_2qs + any_recent_eligible_dp + engagement_most_recent_eligible, 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)
```

# Partner Status

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ has_partner,  
  control_formula = ~ age + is_female + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_response_2qs + any_recent_eligible_dp + engagement_most_recent_eligible, 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)
```

# Socio-economic status

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ income_val,  
  control_formula = ~ age + is_female + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_response_2qs + any_recent_eligible_dp + engagement_most_recent_eligible, 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)
```

# Any response to brief survey

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ any_response_2qs,  
  control_formula = ~ age + is_female + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_response_2qs + any_recent_eligible_dp + engagement_most_recent_eligible, 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)
```

# Engagement at most recent eligible decision point

```{r}
fit1 <- emee(
  data = dat_for_analysis,
  id = "participant_id",  
  outcome = "Y",
  treatment = "coinflip",
  rand_prob = 0.5,
  moderator_formula = ~ any_recent_eligible_dp + engagement_most_recent_eligible,  
  control_formula = ~ age + is_female + is_latino + is_not_latino_and_black + is_not_latino_and_other + baseline_tobacco_history + has_partner + income_val + hour_coinflip_local + days_between_v1_and_coinflip_local + any_response_2qs + any_recent_eligible_dp + engagement_most_recent_eligible, 
  availability = "eligibility"
)

summary(fit1, show_control_fit = TRUE)
```

```{r}
summary(fit1, show_control_fit = FALSE, lincomb = c(0,1,1))
```

